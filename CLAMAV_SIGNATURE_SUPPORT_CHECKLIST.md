# ClamAV Signature Support Checklist

Last update: 2026-02-17

このチェックリストは「sig2yarでどのClamAVシグネチャタイプをサポートできていて、どこが未対応か」を管理するためのメモ。

strict-safe (`false + note`) で残っている不足機能の実装TODOは [`TODO.md`](./TODO.md) で管理する。

---

## 1) トップレベルDBタイプ（拡張子）

### 1.1 現在サポート済み（少なくとも parse 対象）

- [x] `hdb` (hash)
- [x] `hsb` (hash)
- [x] `mdb` (hash)
- [x] `msb` (hash)
- [x] `imp` (hash)
- [x] `ldb` (logical)
- [x] `ndb` (extended/body signatures) ※parse + 実用lower（近似あり）
- [x] `idb` (icon signatures) ※parse + strict-safe lower（`false` + note）
- [x] `cdb` (container metadata signatures) ※parse + strict-safe lower（`false` + note）
- [x] `crb` (trusted/revoked cert signatures) ※parse + strict-safe lower（`false` + note）
- [x] `pdb` (phishing protected-domain signatures) ※parse + strict-safe lower（`false` + note）
- [x] `wdb` (phishing allow-list signatures) ※parse + strict-safe lower（`false` + note）
- [x] `cbc` (bytecode) ※parse + strict-safe lower（`false` + note）
- [x] `ftm` (filetype magic) ※parse + strict-safe lower（`false` + note）
- [x] `fp` (file allow-list/false positive) ※parse + strict-safe lower（`false` + note）
- [x] `sfp` (SHA file allow-list/false positive) ※parse + strict-safe lower（`false` + note）
- [x] `ign` / `ign2` (ignore lists) ※parse + strict-safe lower（`false` + note）

### 1.2 未サポート（parse/lower未対応）

- （現時点では該当なし。更新/差分系は 1.3 管理）

### 1.3 更新/差分系ファイル（取り込み方針未整理）

- [x] `hdu` / `hsu` (parse + strict-safe lower)
- [x] `ldu` (parse + strict-safe lower)
- [x] `mdu` / `msu` (parse + strict-safe lower)
- [x] `ndu` (parse + strict-safe lower)
- [x] `cfg` / `info` （parse + strict-safe lower, 非シグネチャメタデータとして明示）

---

## 2) ldb（logical）内部要素のサポート状況

### 2.1 変換できるもの

- [x] hex subsig -> YARA hex string
- [x] raw subsig -> YARA text string
- [x] pcre-like subsig -> YARA regex string（基本）
- [x] logical condition: `&`, `|`, `=`, `>`, `<`, `=min,max`

### 2.2 近似/暫定対応（要改善）

- [x] `byte_comparison` は `i`(raw, 1/2/4/8byte) と non-raw `=/>/< + exact(e)` を条件式にlower済み。`h` base の数値トークンは hex 値として解釈（例: `=10` -> `0x10`）。offset は `strtol(...,0)` 相当へ寄せ、`0x..`/octal に加えて `+0x..`/`+010` などの明示 `+` 付き数値を受理し、bare-hex（例: `>>0A`）は malformed 扱い。threshold は `0x..`/`+0x..`/`+010` を受理し、digit-only の leading-zero token は base-0 で octal 解釈（例: `=010` -> `8`）、invalid octal（例: `=08` / `=+08`）は malformed。decimal base では bare hex-alpha（例: `A0`）のみ strict false。unsupported ケース（non-rawの非exact/LE/`a`(auto) base・表現不能値・`h` base 幅>18（`CLI_BCOMP_MAX_HEX_BLEN`）・decimal baseでbare hex-alpha閾値、comparison clause 3件以上（ClamAVは最大2件）、negative comparison value、rawの3/5/6/7byte および 9byte+・型幅超過閾値、矛盾した multi-clause、malformed byte_comparison format）は safety false に倒す（fallbackではなく厳密化）。
- [x] `macro` (`${min-max}id$`) は ClamAV source 準拠で **macro group id** として解釈し、未表現部分は safety false に厳密化済み（descending range / invalid format / malformed trailing `$` 欠落 / group>=32 を含む。追記86で linked ndb 側 `offset=$32` など out-of-range group も ignore + false fallback を fixture 固定、追記87で linked ndb body が strict non-representable な場合の ignore + false fallback を fixture 固定、追記88で linked ndb が mixed（一部ignore＋一部採用）でも採用可能メンバーだけで lower 継続する挙動を fixture 固定、追記89で linked ndb が all-ignored（一部invalid target＋一部non-representable body）でも ignore reason を残したうえで macro false fallback する挙動を fixture 固定）。
  - 2026-02-12メモ: Cisco-Talos/clamav の公式テスト参照対象（`unit_tests/check_matchers.c`, `unit_tests/clamscan/regex_test.py`, `unit_tests/clamscan/fuzzy_img_hash_test.py`）および `unit_tests` 配下の `\$\{[0-9]` grep では、macro-group挙動を直接検証できるfixtureを確認できず（未発見）。
  - source根拠: `libclamav/readdb.c` (`${min-max}group$` parse, group<32)、`libclamav/matcher-ac.c` (`macro_lastmatch[group]` 依存)。**単独lowerでは runtime state 非観測のため false+note 維持**。
  - 2026-02-13 追記24: `lower_logical_signature_with_ndb_context(...)` で strict subset の macro↔ndb 連携を追加。`ndb offset=$group` かつ `target_type in {0,1,2,3,4,5,6,7,9,10,11,12}` かつ body が既存NDB strict lowerで表現可能な member のみ採用し、`subsig[idx-1]` 起点の `min-max` window 条件を生成（`target_type=1` は `uint16(0)==0x5A4D`、`target_type=2` は OLE2 guard、`target_type=3` は HTML guard、`target_type=4` は MAIL guard、`target_type=5` は graphics guard、`target_type=6` は `uint32(0)==0x464C457F`、`target_type=7` は ASCII guard、`target_type=9` は Mach-O/FAT guard、`target_type=10` は PDF guard、`target_type=11` は SWF guard、`target_type=12` は Java class guard を併置）。条件外（linkなし / 非direct anchor / non-{0,1,2,3,4,5,6,7,9,10,11,12} target / 非表現body）は **false + note** を維持。
- [x] `fuzzy_img` は専用ハンドリング実装済み（現状は安全側 `false` + note。malformed入力も strict-safe で `false` に統一し、`clamav_unsupported=fuzzy_img_hash_runtime_match` を付与）

### 2.3 未対応/不足

- [x] `MultiGt` / `MultiLt` は単一subsigの occurrence count を反映済み。複合式は厳密表現不能のため **safety false + note** に統一（distinct-count近似は廃止、追記91で単一subsig distinct閾値無視と grouped/incompatible 境界を fixture 固定）
- [x] PCRE flags は `i/s/m/x/U` と ClamAV側 `r/e` を部分反映。`A`・maxshift without `e`・`E`・`g`・legacy `a`・未知/legacy未対応flag は safety false へ厳密化済み。残複雑条件の棚卸しを実施し、strict-safe で表現不能な経路は `false + note` へ統一、fixture で回帰固定済み
- [x] PCRE trigger prefix は trigger条件＋`cli_caloff`主要offset（numeric exact/range, `*`, `EP+/-`, `Sx+`, `SL+`, `SE`, `EOF-`）を条件式に反映済み。`maxshift without e` は safety false、`VI` / macro offset（`$n$`）/不正payloadは source根拠付きで **safety false + note** を維持。さらに trigger式が loweringで `false` に解決された場合（未解決subsig参照など）は、条件を無視せず **rule条件を false + note** に厳密化済み。2026-02-13 追記25で `VI*`（`strncmp("VI",2)`）/ malformed `$...$` 解析方針を source準拠化（いずれも false+note）、2026-02-15 追記34で `A/a` の **offset付きanchor** と **anchor+r/e 複合** を strict-safe false 化、追記59/69で **self-referential trigger**（単独参照だけでなく `0|self` のような混在参照を含む）を false+note 化、追記70で **count/distinct演算子を含む trigger式** を strict-safe false 化、追記71で **offset prefixなしの `r/e` フラグ** を strict-safe false 化、追記119で **offset prefixなし `e` 単独** と **exact offset 上 `re` 併用** の strict-false fixture を補完固定、追記120で **offset prefixなし `r` 単独** と **`*` offset上 `r` 単独** の strict-false fixture を補完固定、追記121で **`*` offset上 `e` 単独** と **anchor+`e`（`Ae`）** の strict-false fixture を補完固定、追記122で **offset付き anchor+`e`（`10:.../Ae`）の note 優先順位（anchor+offset 経路優先）** を fixture で固定、追記123で **offset付き anchor+`r`（`10:.../Ar`）の note 優先順位（anchor+offset 経路優先）** を fixture で固定、追記124で **offset付き anchor+`re`（`10:.../Are`）の note 優先順位（anchor+offset 経路優先）** を fixture で固定、追記72で **`*` offset上の `r/e` フラグ** を strict-safe false 化、追記73で **exact offset上の `r` フラグ** を strict-safe false 化、追記74で **exact offset上の `e` フラグ** を strict-safe false 化、追記75で **maxshift（range）上の `r` フラグ** を strict-safe false 化、追記76で **section-relative maxshift（`Sx+`）上の `r` フラグ挙動** を strict-false fixture で固定、追記77で **`SL+` / `SE` の maxshift 上 `r` フラグ挙動** を strict-false fixture で固定、追記78で **`EP+/-` / `EOF-` の maxshift 上 `r` フラグ挙動** を strict-false fixture で固定、追記79で **`EP-` + maxshift 上 `r` フラグ挙動** を strict-false fixture で補完固定、追記80で **trigger式の mixed missing subsig参照（例: `0|9`）** を strict-false 化、追記81で **trigger-prefix parse failure（missing trigger / malformed trigger式）** を strict-false fixture で固定、追記95/96/97で **trigger式の count/range comparators（`=x` / `>x` / `<x` / `=x,y` / `>x,y` / `<x,y`）** も strict-false fixture で補完固定、追記98/102/103/105/106/107/108/109/110/111/112/113/114/115/116/117/118で **trigger-prefix 内 offset token 境界（malformed `200,abc` / `200,` / `,300` / `200,300,400` / `200,,300` / `200,300,` / `,,300` / `200,,,300` / `200,300,,` / `,300,` / `,300,,` / `,,300,` / `,300,,,` / `,,300,,` / `300,,` / `,,,` / `300,,400` / `,300,,400` / `300,,,400` / `,300,,,400` / `,,,300` / `300,,,,400` と spaced range `200 , 300`）** を fixture で補完固定し、comma 崩れは `parse_pcre_offset_spec` の `split_once(',')` + RHS numeric strict parse で同型 collapse することを追記118で確認（打ち止め判断）、追記99で **trigger-prefix macro-group offset の out-of-range（`$32$`）** を strict-false fixture で補完固定、追記100/101/104で **trigger-prefix macro-group offset の境界（trailing bytes 許容 `$12$junk` / malformed `$12`, `$$`, `$ 12$`, `$12 $`）** を strict-false fixture で補完固定、追記60で **slash含有だがPCRE構文不正な subsig** の raw fallback 経路を閉じて false+note 化、追記61で **`*,maxshift` malformed offset** を false+note 化、追記62で **Target非exec時の `EP/Sx/SL/SE` offset** を false+note 化、追記63で **`e`（encompass）時の maxshift 上限を match-start だけでなく match-end (`@ + !`) でも拘束** するよう厳密化、追記64で **非exec target の `SL+` / `SE` fixture を追加して `EP/Sx/SL/SE` 全系統を strict-false で固定**、追記65で **`EOF-...,maxshift,e` でも `@ + ! <= end` を scan fixture で固定**、追記66で **exec target 側 `Sx/SE/SL` の valid/out-of-range section index を PE fixture scan で固定** 済み。残複雑条件の棚卸しと strict-false 境界固定（追記126）まで完了。
- [x] hex modifier は `i/w/a/f` を反映済み（`w` は wide化、`wa` は ascii|wide の両許容、`iw/ia/iwa` 組合せ含む）。`f` は 2026-02-16 追記92/93/94で non-wide（`::f`）/wide-only（`::wf`）/wide+ascii（`::waf`）を strict subset で実装（non-alnum 境界、wide alnum+NUL 境界、ascii|wide branch-dispatch 境界）。
- [x] target description は `FileSize`/`EntryPoint`/`NumberOfSections` を条件反映し、YARA単体で観測不能な `Engine` / `Container` / `Intermediates` / `IconGroup1` / `IconGroup2` は **safety false + note** へ厳密化。`clamav_unsupported`（`target_description_engine_constraint` / `target_description_container_constraint` / `target_description_intermediates_constraint` / `target_description_icon_group1_constraint` / `target_description_icon_group2_constraint`）を付与して機械可読化済み

### 2.4 ndb（extended/body）の現状

- [x] `DbType::Ndb` 追加（CLIから `ndb` 指定可能）
- [x] parser + IR + renderer 実装
- [x] bodyパターン本体のYARA化（hex/wildcard/jump/alt の基本）
- [x] offsetの主要形式をconditionへ反映（`*`, `n`, `n,m`, `EP±`, `Sx+`, `SL+`, `SE`, `EOF`）
- [x] target_typeの主要条件化（`1,2,3,4,5,6,7,9,10,11,12`）
- [x] DB feature coverageテスト（target/offset/body各カテゴリの代表サンプルを固定検証）
- [x] 複合range jump の strict 化（NDB-4）: signed jump（例: `{-15}`）/ signed-range 派生 / `[]` の非表現構文（open/signed bounds・降順・`AC_CH_MAXDIST(32)`超過）を **safety false + lowering note** に統一。`[]` は ClamAV source準拠で `[n]` / `[n-m]`（昇順かつ `<=32`）のみ通す。
- [x] target_type/offset fixture 拡張（NDB-5）: target_type の invalid literal（非numeric）/ reserved(8) / internal+ (13/14) を safety false + note で固定検証。offset は boundary representable（`1,1`）の match/non-match と、non-representable（`1,`, `EP10`, `EOF+10`, 非exec targetでの `EP+...`）を safety false + note で固定検証。
- [x] `[]` 位置構造制約の strict 化（NDB-6）: ClamAV `matcher-ac` の single-byte flank/core 構造（`ch[0]/ch[1]`）に合わせ、**表現可能形のみ**通し、それ以外（single-byte flank 不成立 / `[]` 3個以上 / 非canonical dual-`[]`）は safety false + lowering note へ統一。
  - 残ギャップ（exact）: EP/Sx/SL/SE の **実ファイル実体（PE/ELF/Mach-O）に対する再計算結果** まで含む end-to-end fixture は未整備（現在は rule文字列/strict-false/scan最小fixture中心）。

---

## 3) 次にやる順（提案 / NDB breakdown）

- [x] **NDB-1**: target_type=7（ASCII正規化）の edge-case 厳密化（uppercase を safety false 相当に弾く lower 条件 + fixture test）
- [x] **NDB-2**: target_type=3（HTML）で root/close tag の境界条件（tag terminator / order）を stricter に整理
- [x] **NDB-3**: target_type=4（MAIL）で header 行頭制約（line-start）を追加して誤検知側をさらに抑制
- [x] **NDB-4**: complex range-jump の残近似（特に `[]` / signed-range 派生）を safety false + note へ寄せる
- [x] **NDB-5**: 未対応 target_type（8/13+以外の invalid 含む）と offset 端ケースの fixture 拡張（`yara_rule`/`yara_compile`）
- [x] **NDB-6**: `[]` jump 位置構造（single-byte flank/core）を source準拠で strict 化し、非表現構造を safety false + note に統一

（継続トラック）
- [x] `byte_comparison` の non-raw base 残edge-caseを厳密 lower で固定（`+0x..` / `+010` 受理、`+08` strict-false、raw可変長 1/2/4/8 制約、non-raw auto-base strict-false、decimal-base hex-alpha strict-false を含む）
- [x] `macro` の strict-safe 運用範囲（macro group解決 / ndb連携）を反映（2026-02-13: ndb context連携の strict subset 実装、2026-02-15: CLI `--ndb-context` 連携、2026-02-16: out-of-range / non-representable / mixed / all-ignored の fallback挙動を fixture 固定）。`macro_lastmatch` の完全runtime同型は引き続き false+note 方針。
- [x] `fuzzy_img` の専用 lower
- [x] PCRE flags / trigger prefix の残課題（複雑trigger-prefix厳密化）
- [x] `idb/cdb/crb/cbc/pdb/wdb` の優先順を暫定決定（実装コスト×件数バランス）
  - `idb`（件数: 223）※2026-02-13 parse + strict-safe lower (`false` + note) 済み
  - `cdb`（件数: 137）※2026-02-13 parse + strict-safe lower (`false` + note) 済み
  - `crb`（件数: 32）※2026-02-13 parse + strict-safe lower (`false` + note) 済み
  - `pdb`（件数: 263）※2026-02-13 parse + strict-safe lower (`false` + note) 済み
  - `wdb`（件数: 185）※2026-02-13 parse + strict-safe lower (`false` + note) 済み
  - `cbc`（件数: 8425）※2026-02-13 parse + strict-safe lower (`false` + note) 済み

---

## 4) メモ（現状観測）

- 2026-02-17 追記139: LDB/PCRE の exact offset + `e/re`（`n:.../e`, `n:.../re`）を strict-false から除外し、strict support 化。
  - 根拠: ClamAV `libclamav/matcher-pcre.c`
    - exact offset では `adjshift == 0`
    - encompass 制限は `encompass && adjshift != 0` のときのみ適用（= exact + `e` では window 非縮小）
    - `rolling` 有効時は anchored を使わない（= exact + `re` は `start >= offset`）
  - 変更: `src/yara.rs` の exact offset lowering を更新し、
    - exact + `e` は equality（`@ == offset`）
    - exact + `re` は rolling exact と同様（`@ >= offset`）
    で strict support。
  - テスト: `tests/yara_rule.rs` / `tests/yara_compile.rs` の exact + `e/re` fixture を strict support 判定へ更新。
- 2026-02-17 追記138: LDB/PCRE の absolute range + `re`（`n,m:.../re`）を strict-false から除外し、strict support 化。
  - 根拠: ClamAV unit test `unit_tests/check_matchers.c` の pcre_testdata Test8/Test10（`/apie/re` with `2,2` = non-match, `/atre/re` with `2,6` = match）。
  - 変更: `src/yara.rs` の absolute range lowering で `re` は bounded window（`@ >= start` かつ `@ + ! <= end`）へ lower。
  - 維持: `r` 単独 + maxshift、および relative offset（`EP/Sx/SL/SE/EOF-`）上の `re` は runtime semantics 未同型のため strict-false 維持。
  - テスト: `tests/yara_rule.rs` / `tests/yara_compile.rs` の `2,6:0/atre/re`・`2,2:0/apie/re` を strict support 判定へ更新。
- 2026-02-17 追記137: LDB/PCRE の exact offset + `r`（rolling）を strict-false から除外し、strict support 化。
  - 根拠: ClamAV unit test `unit_tests/check_matchers.c` の pcre_testdata Test_3（`/basic/r` + offset `0`）で rolling exact は「offset以降での一致」を許容。
  - 変更: `src/yara.rs` の exact offset lowering で `r` 単独時は `for any j ... : (@sX[j] >= offset)` を生成。
  - 維持: exact offset + `re` は runtime semantics 未同型のため strict-false を維持。
  - テスト: `tests/yara_rule.rs` / `tests/yara_compile.rs` の `10:0/abc/r` を positive（match）へ更新。
- 2026-02-17 追記136: LDB/PCRE の `g` flag を strict-false から除外し、同型で strict support 化。
  - 背景: 既存実装は `g` を unsupported flag として一律 strict-false に倒していた。
  - 変更: `src/yara.rs` で `g` を unsupported 判定から除外（PCRE bool-match 文脈では `g` の有無で判定意味が変わらない前提）。
  - テスト: `tests/yara_rule.rs` / `tests/yara_compile.rs` で `0/abc/g` が false にならず compile+match することを固定。
- 2026-02-17 追記135: LDB/PCRE の quote-style named capture（`(?P'name'...)`）を同型rewrite（`(?P<name>...)`）で strict support 化。
  - 変更: `src/yara.rs` に Python-style named syntax 正規化を追加し、`(?P'name'...)` は group名検証後に angle-style へ変換。
  - 維持: `(?P=...)`（named backreference）は yara-x 非対応のため strict-false を維持。
  - テスト: `tests/yara_rule.rs` / `tests/yara_compile.rs` に quote-style rewrite の positive（compile + match）を追加。
- 2026-02-17 追記134: LDB/PCRE の `(?P...)` strict-false 判定を細分化し、yara-x 互換な named-capture subset（`(?P<name>...)`）を strict support 化。
  - 変更: `src/yara.rs` の判定を `pattern.contains("(?P")` から構文種別判定へ更新し、`(?P=...)` / `(?P'...')` / その他非 `<` 系を strict-false へ（※`(?P'...')` は追記135で同型rewrite対応）。
  - 維持: backreference系（`(?P=...)`）は `yara-x` 非互換のため strict-false + note を維持。
  - テスト: `tests/yara_rule.rs` / `tests/yara_compile.rs` に positive（`(?P<funcname>abc)` match）と negative（`(?P=...)`, `(?P'...')` strict-false）を追加。
- 2026-02-17 追記133: strict-safe で残っている不足機能を `TODO.md` として新規作成し、実装可能な strict support 化トラックを分類した。
  - 追加: `TODO.md`（LDB/PCRE・byte_comparison・NDB jump/offset・DBタイプ単位の strict-safe 残課題）
  - 方針: 「実装不足で潰せる strict-false」と「runtime依存で standalone YARA 同型が難しい strict-false」を分離し、前者を優先して解消。
- 2026-02-17 追記132: PCRE の Python-style named capture/backreference 構文（`(?P...)`）を strict-safe false + note に統一。
  - 背景: 実データ scan-diff で `(?P=funcname)` が `yara-x` compile エラー（`unrecognized flag`）を誘発し、検証run停止要因になっていた。
  - 変更: `src/yara.rs` で `parse_pcre_like` 後に `pattern.contains("(?P")` を検出し、`false + note` へ早期収束。
  - テスト: `tests/yara_rule.rs` に note 検証、`tests/yara_compile.rs` に compile/scan（0 hit）検証を追加。
- 2026-02-17 追記131: `hdb/hsb` の最小回帰を sig2yar 本体へ逆輸入し、size固定＋`*`（NoSize）の同時担保を `yara_compile` fixture で固定。
  - 変更: `tests/yara_compile.rs` に `hash_hdb_hsb_rules_match_size_fixed_and_wildcard_variants` を追加。
  - 内容: `abc` の既知 hash（MD5/SHA1/SHA256）を使い、`size=3` と `size=*` の6ルールが target で 6/6 hit、近傍 payload（`abd`）で 0 hit を検証。
  - 目的: validation repo で先に固めた hdb/hsb parity のうち、sig2yar 本体CIで維持すべき最小条件を lightweight に固定（strict-safe方針は不変）。
- 2026-02-17 追記130: 実データとして ClamAV upstream `unit_tests/input`（300 files）を corpus に使い、scan-diff を実行して差分観測を更新。
  - 実行: `CLAMAV_DIFF_CORPUS_DIR=target/validation/clamav-upstream/unit_tests/input CLAMAV_DIFF_SAMPLE_SIZE=500 CLAMAV_DIFF_SEED=7331 scripts/logical-scan-diff.sh`
  - 結果: `target/validation/scan-diff/run.PIxriQ/summary.json` で `clamav_hit_total(filtered)=0` / `yara_hit_total(filtered)=0` / `mismatch_files=0`。
  - 観測: 実コーパス上で sampled logical signatures（500件）との交差がなく、分類軸（strict-false/non-strict）は今回0件。
  - 追加観測: sample size を 3000 へ増やした実行では、生成YARA内の一部PCRE（named backreference `(?P=...)`）を `yara-x` が compile できず run 失敗（`error[E014]: invalid regular expression`）。
  - 次アクション: 実データ差分を継続取得するため、(a) corpus と logical signature の交差を先に見積もる prefilter、または (b) un-compilable rule を集計しつつ skip して run 継続する運用/実装が必要。
- 2026-02-17 追記129: scan-diff の差分レポートに分類軸を追加し、`only_clamav` を strict-false 由来か非strict差分かで分離して可視化。
  - 変更: `scripts/logical-scan-diff.sh` の集計処理で生成YARA（`sample.yar`）から `condition` / `clamav_unsupported` / `clamav_lowering_notes` を抽出し、差分カテゴリを付与。
  - 追加出力: `summary.json` に `only_clamav_strict_false_total` / `only_clamav_non_strict_total` / `mismatch_category_files` / `top_strict_false_unsupported_tags` を追加。
  - 追加出力: `mismatches.tsv` に `only_clamav_strict_false` / `only_clamav_non_strict` / `strict_false_unsupported_tags` 列を追加。
  - 追加出力: `report.md` に mismatch categorization セクションを追加し、strict-false由来差分と要調査差分（non-strict）を分離して確認可能に。
  - 方針: レポート成果物は `target/validation/scan-diff/run.*` 配下のみ（リポジトリへは非コミット）。
- 2026-02-17 追記128: ClamAV実体スキャンとの差分可視化を始めるため、sampled logical signatures を対象に `ClamAV(clamscan)` と `sig2yar+yara-x` のヒット差分を集計する検証スクリプトを追加。
  - 変更: `scripts/logical-scan-diff.sh` を追加。`CLAMAV_DIFF_CORPUS_DIR` を入力に、(1) `.ldb` reservoir sampling、(2) `sig2yar` で ruleset 生成、(3) `yara_scan_corpus` でヒット収集、(4) Docker上 `clamscan --allmatch` 結果との比較、(5) `summary.json` / `mismatches.tsv` / `report.md` 出力までを自動化。
  - 変更: `src/bin/yara_scan_corpus/main.rs` を追加（YARA rules + corpus を受けて `<file>\t<rule_id>` ヒットをTSV出力）。
  - 補助: `Makefile.toml` に `validation-scan-diff` task を追加。
- 2026-02-17 追記127: 検証フェーズの初手として、ClamAV DB サンプル上の logical lowering で strict-false へ落ちたルールが explanation meta（`clamav_lowering_notes` または `clamav_unsupported`）を持つことを自動検証するテストを追加。
  - 変更: `tests/clamav_db.rs` に `yara_logical_db_samples_strict_false_paths_are_explained` を追加し、sampled `.ldb` を parse/lower/compile したうえで strict-false 経路の無注釈化を検出。
  - 目的: strict-safe 運用で「false になった理由」が追跡不能になる回帰を防止し、検証フェーズでの観測性を確保。
  - 補助: `CLAMAV_VALIDATION_VERBOSE=1` 時に unsupported tag の集計を stderr へ出力できるよう追加。
- 2026-02-17 追記126: PCRE flags/trigger-prefix 残課題を棚卸しし、trigger式が既存subsigの strict-false に依存して実質 `false` になる経路を明示固定して複雑条件トラックを完了。
  - 背景: 既存の `lower_pcre_trigger_condition(...)` は missing index / self-reference / count-distinct 不可表現を strict-false 化済みだったが、**参照先subsig自体が strict-false（例: malformed PCRE）** の場合に「resolved to false」経路の fixture が未整備だった。
  - 変更: `src/yara.rs` に `pcre_trigger_expression_definitely_false(...)` を追加し、representable trigger式でも参照先が確定falseなら `false + note` に早期収束するよう厳密化。
  - テスト: `tests/yara_rule.rs` / `tests/yara_compile.rs` に `Foo.Bar-1;Target:1;1;fuzzy_img##0;0:0/xyz/` fixture を追加し、`trigger expression resolved to false` note と scan non-match を固定。
  - checklist: 2.3 の PCRE flags / trigger-prefix 未完了項目と継続トラックの残課題を [x] 化。
- 2026-02-17 追記125: target description の未反映キー（`Engine` / `IconGroup1` / `IconGroup2`）を strict-safe false + unsupported meta で固定し、意味反映トラックを完了。
  - 背景: 既存実装は `FileSize` / `EntryPoint` / `NumberOfSections` と `Container` / `Intermediates` のみを lower 対象にしており、`Engine` / `IconGroup1` / `IconGroup2` は parse 後に IRへ載らず silently drop されていた。
  - 変更: `src/ir.rs` / `src/parser/logical/target_description.rs` で `engine` / `icon_group1` / `icon_group2` を IR へ保持し、`src/yara.rs` の target description lowering で standalone YARA 非観測要素として `false + note` に統一。併せて `clamav_unsupported` に `target_description_engine_constraint` / `target_description_icon_group1_constraint` / `target_description_icon_group2_constraint` を追加。
  - テスト: `tests/yara_rule.rs` / `tests/yara_compile.rs` に `Engine:51-255` と `IconGroup1/2` の strict-false fixture を追加し、note / unsupported meta / scan non-match を固定。
- 2026-02-16 追記124: PCRE flags の note 優先順位境界（offset付き anchor+`re`）を strict-false fixture で固定。
  - 背景: 追記122/123で `10:.../Ae` と `10:.../Ar` の優先順位は固定済みだったが、`10:.../Are` の優先順位（anchor+offset 優先）は未固定だった。
  - テスト: `tests/yara_rule.rs` / `tests/yara_compile.rs` に `10:0/abc/Are` を追加し、`anchored flag with explicit offset prefix cannot be represented safely` note + scan non-match を固定。
- 2026-02-16 追記123: PCRE flags の note 優先順位境界（offset付き anchor+`r`）を strict-false fixture で固定。
  - 背景: 追記122で `10:.../Ae` の優先順位は固定済みだったが、同系列の `10:.../Ar` の優先順位（anchor+offset 優先）は未固定だった。
  - テスト: `tests/yara_rule.rs` / `tests/yara_compile.rs` に `10:0/abc/Ar` を追加し、`anchored flag with explicit offset prefix cannot be represented safely` note + scan non-match を固定。
- 2026-02-16 追記122: PCRE flags の note 優先順位境界（offset付き anchor+`e`）を strict-false fixture で固定。
  - 背景: `Ae` は追記121で固定済みだが、offset付き（`10:.../Ae`）では `anchor+offset` note と `anchor+r/e` note のどちらを採るかの優先順位が未固定だった。
  - テスト: `tests/yara_rule.rs` / `tests/yara_compile.rs` に `10:0/abc/Ae` を追加し、`anchored flag with explicit offset prefix cannot be represented safely` note + scan non-match を固定。
- 2026-02-16 追記121: PCRE flags/offset runtime semantics の strict-false coverage を追加補完（`*` offset上 `e` 単独 / anchor+`e`）。
  - 背景: 追記119/120で `r/e` の singleton 境界を順次固定したが、`*` offset 上 `e` 単独と anchor+`e`（`Ae`）の明示 fixture は未固定だった。
  - テスト: `tests/yara_rule.rs` / `tests/yara_compile.rs` に `*:0/abc/e` と `0/abc/Ae` を追加し、`flag(s) 'e' on '*' offset prefix` / `anchored flag combined with rolling/encompass flags is not representable safely` note + scan non-match を固定。
- 2026-02-16 追記120: PCRE flags/offset runtime semantics の strict-false coverage を追加補完（offsetなし `r` 単独 / `*` offset上 `r` 単独）。
  - 背景: 追記71/72/119で `r/e` unsafe 組み合わせの多くは固定済みだったが、`r` 単独の代表境界（offsetなし / `*` offset）が未固定だった。
  - テスト: `tests/yara_rule.rs` / `tests/yara_compile.rs` に `0/abc/r` と `*:0/abc/r` を追加し、`flag(s) 'r' require explicit offset/maxshift runtime semantics` / `flag(s) 'r' on '*' offset prefix` note + scan non-match を固定。
- 2026-02-16 追記119: PCRE flags/offset runtime semantics の strict-false coverage を補完（offsetなし `e` 単独 / exact offset 上 `re` 併用）。
  - 背景: 追記71〜75で `r/e` の主要 unsafe 組み合わせは strict 化済みだったが、`e` 単独（offsetなし）と `re` 併用（exact offset）の明示 fixture が未固定だった。
  - テスト: `tests/yara_rule.rs` / `tests/yara_compile.rs` に `0/abc/e` と `10:0/abc/re` を追加し、`flag(s) 'e' require explicit offset/maxshift runtime semantics` / `flag 'r' with exact offset prefix` note + scan non-match を固定。
- 2026-02-16 追記118: PCRE trigger-prefix malformed comma-offset の棚卸しを実施し、comma 崩れ境界を打ち止め判断。
  - 根拠: `parse_pcre_offset_spec(...)` は最初の `,` で `split_once(',')` し、RHS は `parse_ascii_u64`（ASCII digitのみ）で厳密parseするため、追加の comma 派生は同じ `Unsupported(<raw>)` 経路へ collapse する。
  - 既存 fixture 群（追記98/102/103/105〜117）で、missing base / trailing comma / multi-empty / empty-middle+numeric-tail / comma-only / spaced range の各境界クラスを網羅済み。
  - 結論: malformed comma 系は coverage 完了。残課題は PCRE flags/trigger-prefix の runtime semantics 側 strict 化。
- 2026-02-16 追記117: PCRE trigger-prefix の malformed numeric offset（comma-only numeric-tail / deep empty-middle numeric-tail）strict-false coverage を補完（`,,,300`, `300,,,,400`）。
  - 背景: 追記116までで empty-middle + numeric-tail の主要派生は固定済みだったが、comma-only に numeric tail が続く形（`,,,300`）と empty-middle がさらに深い形（`300,,,,400`）は未固定だった。
  - テスト: `tests/yara_rule.rs` / `tests/yara_compile.rs` に `,,,300:0/abc/` と `300,,,,400:0/abc/` を追加し、`pcre offset prefix ',,,300' unsupported` / `pcre offset prefix '300,,,,400' unsupported` note + scan non-match を固定。
- 2026-02-16 追記116: PCRE trigger-prefix の malformed numeric offset（empty-middle + numeric-tail 深掘り派生）strict-false coverage を補完（`300,,,400`, `,300,,,400`）。
  - 背景: 追記115で empty-middle + numeric-tail の基本形（`300,,400` 系）は固定済みだったが、empty token が2連続する深掘り派生（`300,,,400` 系）が未固定だった。
  - テスト: `tests/yara_rule.rs` / `tests/yara_compile.rs` に `300,,,400:0/abc/` と `,300,,,400:0/abc/` を追加し、`pcre offset prefix '300,,,400' unsupported` / `pcre offset prefix ',300,,,400' unsupported` note + scan non-match を固定。
- 2026-02-16 追記115: PCRE trigger-prefix の malformed numeric offset（empty-middle + numeric-tail 派生）strict-false coverage を補完（`300,,400`, `,300,,400`）。
  - 背景: comma 崩れ境界は empty token 中心で補完が進んだが、empty-middle の後ろに numeric token が続く複合崩れ（`300,,400` 系）は未固定だった。
  - テスト: `tests/yara_rule.rs` / `tests/yara_compile.rs` に `300,,400:0/abc/` と `,300,,400:0/abc/` を追加し、`pcre offset prefix '300,,400' unsupported` / `pcre offset prefix ',300,,400' unsupported` note + scan non-match を固定。
- 2026-02-16 追記114: PCRE trigger-prefix の malformed numeric offset（missing base/comma deep 派生の追加）strict-false coverage を補完（`300,,`, `,,,`）。
  - 背景: missing base/comma 系の派生は `,300,,,` / `,,300,,` まで固定済みだったが、baseのみ＋trailing multi-empty（`300,,`）と comma-only（`,,,`）の端境界が未固定だった。
  - テスト: `tests/yara_rule.rs` / `tests/yara_compile.rs` に `300,,:0/abc/` と `,,,:0/abc/` を追加し、`pcre offset prefix '300,,' unsupported` / `pcre offset prefix ',,,' unsupported` note + scan non-match を固定。
- 2026-02-16 追記113: PCRE trigger-prefix の malformed numeric offset（missing base/comma composite の追加派生）strict-false coverage を補完（`,300,,,`, `,,300,,`）。
  - 背景: 追記112で `,300,,` / `,,300,` は固定済みだったが、同系列の 1段深い comma 崩れ（missing base + double trailing empty / double leading + trailing multi-empty）が未固定だった。
  - テスト: `tests/yara_rule.rs` / `tests/yara_compile.rs` に `,300,,,:0/abc/` と `,,300,,:0/abc/` を追加し、`pcre offset prefix ',300,,,' unsupported` / `pcre offset prefix ',,300,,' unsupported` note + scan non-match を固定。
- 2026-02-16 追記112: PCRE trigger-prefix の malformed numeric offset（missing base/comma composite variants）strict-false coverage を補完（`,300,,`, `,,300,`）。
  - 背景: 追記111で `,300,` は固定済みだったが、missing base 系の comma 崩れ派生（末尾 multi-empty / 先頭 double + 末尾 comma）が未固定だった。
  - テスト: `tests/yara_rule.rs` / `tests/yara_compile.rs` に `,300,,:0/abc/` と `,,300,:0/abc/` を追加し、`pcre offset prefix ',300,,' unsupported` / `pcre offset prefix ',,300,' unsupported` note + scan non-match を固定。
- 2026-02-16 追記111: PCRE trigger-prefix の malformed numeric offset（missing base + trailing comma token）strict-false coverage を補完（`,300,`）。
  - 背景: malformed numeric offset の comma 系は `200,300,,` まで固定済みだったが、base欠落と末尾comma崩れが同時に起きる複合境界（`,300,`）が未固定だった。
  - テスト: `tests/yara_rule.rs` / `tests/yara_compile.rs` に `,300,:0/abc/` を追加し、`pcre offset prefix ',300,' unsupported` note + scan non-match を固定。
- 2026-02-16 追記110: PCRE trigger-prefix の malformed numeric offset（trailing multi-empty comma tokens）strict-false coverage を補完（`200,300,,`）。
  - 背景: malformed numeric offset の comma 系は `200,,,300` まで固定済みだったが、末尾側に空トークンが連続する複合崩れ（`200,300,,`）境界が未固定だった。
  - テスト: `tests/yara_rule.rs` / `tests/yara_compile.rs` に `200,300,,:0/abc/` を追加し、`pcre offset prefix '200,300,,' unsupported` note + scan non-match を固定。
- 2026-02-16 追記109: PCRE trigger-prefix の malformed numeric offset（multi-empty comma tokens）strict-false coverage を補完（`200,,,300`）。
  - 背景: malformed numeric offset の comma 系は `,,300` まで固定済みだったが、空トークンが複数連続する複合崩れ（`200,,,300`）境界が未固定だった。
  - テスト: `tests/yara_rule.rs` / `tests/yara_compile.rs` に `200,,,300:0/abc/` を追加し、`pcre offset prefix '200,,,300' unsupported` note + scan non-match を固定。
- 2026-02-16 追記108: PCRE trigger-prefix の malformed numeric offset（double leading comma token）strict-false coverage を補完（`,,300`）。
  - 背景: malformed numeric offset の comma 系は `200,300,` まで固定済みだったが、先頭側が二重で欠落する複合崩れ（`,,300`）境界が未固定だった。
  - テスト: `tests/yara_rule.rs` / `tests/yara_compile.rs` に `,,300:0/abc/` を追加し、`pcre offset prefix ',,300' unsupported` note + scan non-match を固定。
- 2026-02-16 追記107: PCRE trigger-prefix の malformed numeric offset（trailing comma token）strict-false coverage を補完（`200,300,`）。
  - 背景: malformed numeric offset の comma 系は `200,300,400` / `200,,300` まで固定済みだったが、末尾側に空トークンが出る複合崩れ（`200,300,`）境界が未固定だった。
  - テスト: `tests/yara_rule.rs` / `tests/yara_compile.rs` に `200,300,:0/abc/` を追加し、`pcre offset prefix '200,300,' unsupported` note + scan non-match を固定。
- 2026-02-16 追記106: PCRE trigger-prefix の malformed numeric offset（empty middle token）strict-false coverage を補完（`200,,300`）。
  - 背景: malformed numeric offset の comma 系は `200,300,400` まで固定済みだったが、空トークンを含む複合崩れ（`200,,300`）境界が未固定だった。
  - テスト: `tests/yara_rule.rs` / `tests/yara_compile.rs` に `200,,300:0/abc/` を追加し、`pcre offset prefix '200,,300' unsupported` note + scan non-match を固定。
- 2026-02-16 追記105: PCRE trigger-prefix の malformed numeric offset（extra comma）strict-false coverage を補完（`200,300,400`）。
  - 背景: malformed numeric offset は `200,abc` / `200,` / `,300` までは固定済みだったが、comma が複数含まれる token の境界が未固定だった。
  - テスト: `tests/yara_rule.rs` / `tests/yara_compile.rs` に `200,300,400:0/abc/` を追加し、`pcre offset prefix '200,300,400' unsupported` note + scan non-match を固定。
- 2026-02-16 追記104: PCRE trigger-prefix の malformed macro offset（space混在）strict-false coverage を補完（`$ 12$`, `$12 $`）。
  - 背景: malformed macro offset は `$12` / `$$` まで固定済みだったが、`$` と数字/終端 `$` の間に空白が混ざるケースは未固定だった。
  - テスト: `tests/yara_rule.rs` / `tests/yara_compile.rs` に `$ 12$:0/abc/` と `$12 $:0/abc/` を追加し、`pcre macro offset '<raw>' has invalid format` note + scan non-match を固定。
- 2026-02-16 追記103: PCRE trigger-prefix の spaced range offset（`200 , 300`）挙動を fixture 固定。
  - 背景: offset token 端境界のうち、space 混在時の trim 挙動が未固定だった。
  - テスト: `tests/yara_rule.rs` / `tests/yara_compile.rs` に ` 200 , 300 :0/abc/` を追加し、`maxshift present without 'e'; lowered to false for safety` note + scan non-match を固定。
- 2026-02-16 追記102: PCRE trigger-prefix の malformed numeric offset strict-false coverage を補完（`200,` / `,300`）。
  - 背景: 追記98で `200,abc` は固定済みだったが、comma 区切りの片側欠落（maxshift欠落 / base欠落）ケースが未固定だった。
  - テスト: `tests/yara_rule.rs` / `tests/yara_compile.rs` に `200,:0/abc/` と `,300:0/abc/` を追加し、`pcre offset prefix '<raw>' unsupported` note + scan non-match を固定。
- 2026-02-16 追記101: PCRE trigger-prefix の malformed macro offset strict-false coverage を補完（`$12`, `$$`）。
  - 背景: 追記100で `$12$junk`（trailing bytes 許容）は固定済みだったが、closing `$` 欠落や digit 欠落の malformed macro offset は未固定だった。
  - テスト: `tests/yara_rule.rs` / `tests/yara_compile.rs` に `$12:0/abc/` と `$$:0/abc/` を追加し、`pcre macro offset '<raw>' has invalid format` note + scan non-match を固定。
- 2026-02-16 追記100: PCRE trigger-prefix の macro-group trailing bytes strict-false coverage を補完。
  - 背景: `$n$` offset は runtime依存 false+note で運用中だが、ClamAV `sscanf("$%u$")` 由来の trailing bytes 許容（例: `$12$junk`）ケースが未固定だった。
  - テスト: `tests/yara_rule.rs` / `tests/yara_compile.rs` に `$12$junk:0/abc/` を追加し、`pcre offset `$12$` depends on CLI_OFF_MACRO runtime state` note + scan non-match を固定。
- 2026-02-16 追記99: PCRE trigger-prefix の macro-group out-of-range strict-false coverage を補完。
  - 背景: `$n$` offset は runtime依存で false+note 化済みだったが、`n>=32`（ClamAV上限外）の境界が trigger-prefix ケースで未固定だった。
  - テスト: `tests/yara_rule.rs` / `tests/yara_compile.rs` に `$32$:0/abc/` を追加し、`pcre macro-group offset `$32$` out of range` note + scan non-match を固定。
- 2026-02-16 追記98: PCRE trigger-prefix の malformed offset strict-false coverage を補完。
  - 背景: trigger-prefix では missing trigger / malformed trigger式 / missing参照は固定済みだったが、offset token 自体が malformed（例: `200,abc`）なケースが未固定だった。
  - テスト: `tests/yara_rule.rs` / `tests/yara_compile.rs` に `200,abc:0/abc/` を追加し、`pcre offset prefix '200,abc' unsupported` note + scan non-match を固定。
- 2026-02-16 追記97: PCRE trigger-prefix の count strict-false coverage を追加補完（`>x` / `<x`）。
  - 背景: 追記95/96で `=x` / `=x,y` / `>x,y` / `<x,y` は固定済みだったが、`>x`（Gt）と `<x`（Lt）の trigger式ケースが未固定だった。
  - テスト: `tests/yara_rule.rs` / `tests/yara_compile.rs` に `200,300:(0|1)>1/abc/` と `200,300:(0|1)<2/abc/` を追加し、`count/distinct operators unsupported for strict lowering` note + scan non-match を固定。
- 2026-02-16 追記96: PCRE trigger-prefix の count/distinct strict-false coverage を追加補完（`<x,y`）。
  - 背景: 追記95で `=x,y` / `>x,y` は固定済みだったが、`<x,y`（MultiLt）の trigger式ケースが未固定だった。
  - テスト: `tests/yara_rule.rs` / `tests/yara_compile.rs` に `200,300:(0|1)<2,1/abc/` を追加し、`count/distinct operators unsupported for strict lowering` note + scan non-match を固定。
- 2026-02-16 追記95: PCRE trigger-prefix の count/distinct strict-false coverage を補完。
  - 背景: `=1`（MatchCount）は固定済みだったが、`=x,y`（MultiMatchCount）と `>x,y`（MultiGt）の trigger式ケースが未固定だった。
  - テスト: `tests/yara_rule.rs` / `tests/yara_compile.rs` に `200,300:(0|1)=1,2/abc/` と `200,300:(0|1)>1,1/abc/` を追加し、`count/distinct operators unsupported for strict lowering` note + scan non-match を固定。
- 2026-02-16 追記94: hex modifier `f` の strict subset を wide+ascii（`::waf`）へ拡張。
  - 背景: 追記92/93で `::f` と `::wf` は固定済みだったため、次段として `::waf` の ascii/wide 統合挙動を `!s` 長で branch dispatch して strict-safe で表現可能な範囲へ拡張。
  - 実装: `src/yara.rs` に `hex_fullword_wide_ascii_condition_expr(...)` を追加し、`!s==ascii_len` では non-alnum 境界、`!s==wide_len` では wide alnum+NUL 境界を適用。
  - テスト: `tests/yara_rule.rs` / `tests/yara_compile.rs` に `68656c6c6f::waf` の ascii/wide 境界 match/non-match（`hello`, `xhello`, `hello1`, wide `hello`, `x\0hello`, `hello\0y`）を追加。
- 2026-02-16 追記93: hex modifier `f` の strict subset を wide-only（`::wf`）へ拡張。
  - 背景: 追記92で non-wide（`::f`）は固定済みだったため、次段として wide-only の alnum+NUL 境界を strict-safe で表現可能な範囲に限定して実装。
  - 実装: `src/yara.rs` で `::wf` に `for any i in (1..#sN)` + 前後2byte境界（`[A-Za-z0-9]\x00`）の否定条件を導入。
  - テスト: `tests/yara_rule.rs` / `tests/yara_compile.rs` に `68656c6c6f::wf` の boundary match/non-match（wide `hello`, `_\0hello\0_\0`, `x\0hello\0`, `hello\0y\0`）を追加。
- 2026-02-16 追記92: hex modifier `f` の strict subset 実装として、non-wide（`::f`）を non-alnum 境界条件で fixture 固定。
  - 背景: 追記82で `wf` / `waf` を strict-false 固定済みだが、`::f` 単体は strict-safeで表現可能な範囲が未実装だった。
  - 実装: `src/yara.rs` で `::f`（non-wide）時に `for any i in (1..#sN)` + 前後境界（`uint8(@-1)` / `uint8(@+!)`）の non-alnum 判定を条件式化。
  - テスト: `tests/yara_rule.rs` / `tests/yara_compile.rs` に `68656c6c6f::f` の境界 match/non-match（`hello` / `xhello` / `hello1` / `_hello_`）を追加（その後、追記93で `::wf` も strict subset 実装へ拡張）。
- 2026-02-16 追記91: `MultiGt` / `MultiLt` の境界条件を fixture で固定。
  - 背景: grouped strict-false は既存固定済みだったが、single-subsig + distinct 閾値（ignore）と grouped + incompatible distinct（false）の分岐が compile/scan で未固定だった。
  - テスト: `tests/yara_rule.rs` / `tests/yara_compile.rs` に `0>2,2`（single multi-gt distinct ignore）、`0<3,2`（single multi-lt distinct ignore）、`(0|1)<3,3`（grouped incompatible distinct false）を追加し、note と match/non-match を固定。
- 2026-02-16 追記90: checklist の未完表示を実装実態に合わせて整理。
  - 変更: 2.2 の `byte_comparison` / `macro` を `[x]` 化し、3) 継続トラック側も「strict-safe 運用範囲で完了済み」の文言へ更新。
  - 意図: full runtime 同型を目指す項目と、strict-safe で intentionally false+note に倒す項目を分離し、未完タスクを PCRE複雑条件・hex `f` 本実装・target description 意味反映本体へ収束。
- 2026-02-16 追記89: macro linked ndb の all-ignored case（一部invalid target＋一部non-representable body）を fixture 固定。
  - 背景: mixed case（追記88）は固定済みだが、同一groupの候補が最終的に全滅するケースで ignore reason を保持しつつ macro false fallback する挙動が未固定だった。
  - テスト: `tests/yara_rule.rs` / `tests/yara_compile.rs` に `D1:8:$12:626262`（invalid target）+ `D2:0:$12:AA{-15}BB`（non-representable body）の fixture を追加し、target/body 両理由と `macro-group `$12$` semantics depend on CLI_OFF_MACRO` note、および scan non-match を固定。
- 2026-02-16 追記88: macro linked ndb の mixed case（一部ignore＋一部採用）を fixture 固定。
  - 背景: group境界（追記86）と body非表現（追記87）は個別固定済みだが、同一groupで「非表現memberを捨てつつ、表現可能memberで継続する」挙動が未固定だった。
  - テスト: `tests/yara_rule.rs` / `tests/yara_compile.rs` に `D1:0:$12:AA{-15}BB`（ignore）+ `D2:0:$12:626262`（採用）の mixed fixture を追加し、ignore reason note と `resolved via linked ndb members [D2]` を同時検証。scan は match/non-match を固定。
- 2026-02-16 追記87: macro linked ndb の body representability 境界として、strict non-representable body を ignore + false fallback で fixture 固定。
  - 背景: linked ndb の group/target 境界は固定済みだったが、body 側が strict non-representable（例: signed jump）な場合の ignore 理由 note が未固定だった。
  - テスト: `tests/yara_rule.rs` / `tests/yara_compile.rs` に `D1:0:$12:AA{-15}BB` fixture を追加し、`not representable in strict YARA lowering` + reason (`ndb signed jump`) + macro fallback `false`（scan non-match）を固定。
- 2026-02-16 追記86: macro linked ndb の group境界として、`offset=$32`（out-of-range）を ignore + false fallback で fixture 固定。
  - 背景: macro subsig 側の `group>=32` strict-false は固定済みだったが、linked ndb context 側の out-of-range group（`$32`）の ignore挙動が未固定だった。
  - テスト: `tests/yara_rule.rs` / `tests/yara_compile.rs` に `D1:0:$32:...` fixture を追加し、`offset group $32 outside 0..31` note と macro fallback `false`（scan non-match）を固定。
- 2026-02-16 追記85: `byte_comparison` の base-0 parse 境界として、`+08`（先頭 `+` + invalid octal）を malformed として strict-false 固定。
  - 背景: `+010`（追記84）を受理した一方で、invalid octal 側（`+08`）の reject 挙動が未固定だった。
  - テスト: `tests/yara_rule.rs` / `tests/yara_compile.rs` に `>>+08` offset と `=+08` threshold fixture を追加し、`false + note` / scan non-match を固定。
- 2026-02-16 追記84: `byte_comparison` の `strtol(...,0)` 準拠境界として、`+010`（先頭 `+` + octal）の offset / threshold 解釈を fixture で固定。
  - 背景: 追記83で `+0x..` を固定したが、先頭 `+` と leading-zero octal の組み合わせ（`+010`）が未固定だった。
  - テスト: `tests/yara_rule.rs` / `tests/yara_compile.rs` に `>>+010` offset と `=+010` threshold fixture を追加し、octal（8）としての match 挙動を固定。
- 2026-02-16 追記83: `byte_comparison` の `strtol(...,0)` 準拠境界として、offset / threshold の明示 `+` 付き数値トークンを fixture で固定。
  - 背景: 既存実装は `0x..` / octal を受理していたが、ClamAV source の `strtol/strtoll(..., 0)` が受理する `+0x..` などの先頭 `+` を未反映だった。
  - 変更: `src/yara.rs` の `parse_clamav_base0_u64(...)` と `ByteCmpBase::Hex` threshold parse を更新し、先頭 `+` を許容。
  - テスト: `tests/yara_rule.rs` / `tests/yara_compile.rs` に `>>+0xA` offset と `=+0xA` threshold の fixture を追加し、match 挙動を固定。
- 2026-02-16 追記82: hex modifier `f`（fullword）未実装トラックの strict-safe 固定として、`wf` / `waf` 併用時も strict-false fixture で固定。
  - 背景: `f` 単体は strict-false で固定済みだったが、wide系 modifier 併用（`wf` / `waf`）でも同一安全側挙動を維持することを回帰不能化する。
  - テスト: `tests/yara_rule.rs` に `68656c6c6f::wf` / `68656c6c6f::waf` の condition=false + note assertion を追加。`tests/yara_compile.rs` に wide/wide-ascii 入力の scan non-match fixture を追加。
- 2026-02-16 追記81: PCRE trigger-prefix の複雑条件として、parse failure ケース（missing trigger / malformed trigger式）を strict-false fixture で固定。
  - 背景: strict-safe 方針上、trigger prefix が parse できない／trigger式を構文解析できない場合は常に `false + note` で落とすことを回帰不能化する。
  - テスト: `tests/yara_rule.rs` / `tests/yara_compile.rs` に `200,300:/abc/`（missing trigger）と `200,300:foo/abc/`（malformed trigger式）fixture を追加し、note と scan non-match を固定。
- 2026-02-16 追記80: PCRE trigger-prefix の複雑条件として、trigger式に mixed missing subsig参照（例: `0|9`）を含むケースを strict-safe false 化。
  - 背景: 既存実装は missing subsig を `false` へ部分置換するため、`OR` 混在（`valid | missing`）だと missing 項が事実上無視される余地があった。
  - 変更: `src/yara.rs` の `lower_pcre_trigger_condition(...)` で trigger式に missing subsig参照が1つでもあれば `false + note` に統一。
  - テスト: `tests/yara_rule.rs` / `tests/yara_compile.rs` に `0|9/abc/` fixture を追加し、note と scan non-match を固定。
- 2026-02-16 追記79: PCRE flags/trigger-prefix の複雑条件として、`EP-` + maxshift 上で `r` を使うケースを strict-false fixture で補完固定。
  - 背景: 追記78で `EP+/-` を一括記載したが、fixture は `EP+` 側のみだったため `EP-` 側の回帰防止を明示追加する。
  - テスト: `tests/yara_rule.rs` / `tests/yara_compile.rs` に `EP-10,8:0/abc/re` fixture を追加し、note と scan non-match を固定。
- 2026-02-16 追記78: PCRE flags/trigger-prefix の複雑条件として、`EP+/-` / `EOF-` の maxshift 上で `r` を使うケースを strict-false fixture で固定。
  - 背景: section-relative 系に続き、offset family 全体（EP/EOF）でも `Range && r => false + note` が崩れないことを fixture で明示固定する。
  - テスト: `tests/yara_rule.rs` / `tests/yara_compile.rs` に `EP+10,8:0/abc/re` / `EOF-10,8:0/abc/re` fixture を追加し、note と scan non-match を固定。
- 2026-02-16 追記77: PCRE flags/trigger-prefix の複雑条件として、`SL+` / `SE` の maxshift 上で `r` を使うケースを strict-false fixture で固定。
  - 背景: `Sx+` 系に続き、section-relative 系 (`SL+...,maxshift` / `SE...,maxshift`) でも `Range && r => false + note` が崩れないことを PE fixture で明示固定する。
  - テスト: `tests/yara_rule.rs` / `tests/yara_compile.rs` に `SL+16,4:0/abc/re` / `SL+4,8:0/abc/re` / `SE1,4:0/abc/re` fixture を追加し、note と scan non-match を固定。
- 2026-02-16 追記76: PCRE flags/trigger-prefix の複雑条件として、section-relative maxshift（`Sx+`）上で `r` を使うケースを strict-false fixture で固定。
  - 背景: 追記75で `Range && r` を `false + note` に統一したため、section-relative (`Sx+...,maxshift`) でも同一安全側挙動になることを PE fixture で明示固定する。
  - テスト: `tests/yara_rule.rs` / `tests/yara_compile.rs` に `S2+4,8:0/abc/re` / `S1+4,8:0/abc/re` fixture を追加し、note と scan non-match を固定。
- 2026-02-16 追記75: PCRE flags/trigger-prefix の複雑条件として、maxshift（range）上で `r` を使うケースを strict-safe false 化。
  - 背景: 既存実装は maxshift 併用時の `r` を ignore していたが、ClamAV rolling scan-state semantics と一致する保証がなく近似リスクが残るため。
  - 変更: `src/yara.rs` の `lower_pcre_offset_window_condition(...)` で `Range && r` を `false + note` に統一。
  - テスト: `tests/yara_rule.rs` / `tests/yara_compile.rs` の `2,6:0/atre/re` / `2,2:0/apie/re` fixture を strict-false 検証へ更新。
- 2026-02-16 追記74: PCRE flags/trigger-prefix の複雑条件として、exact offset 上で `e` を使うケースを strict-safe false 化。
  - 背景: 既存実装は exact offset + `e` を no-op として扱っていたが、ClamAV encompass runtime semantics を standalone YARAで同型保証できないため安全側へ寄せる。
  - 変更: `src/yara.rs` の `lower_pcre_offset_window_condition(...)` で `Exact && e` を `false + note` に統一。
  - テスト: `tests/yara_rule.rs` / `tests/yara_compile.rs` に `10:0/abc/e` fixture を追加し、note と scan non-match を固定。
- 2026-02-16 追記73: PCRE flags/trigger-prefix の複雑条件として、exact offset 上で `r` を使うケースを strict-safe false 化。
  - 背景: 既存実装は exact offset + `r` を `@ >= start` へlowerしていたが、ClamAV runtime の rolling scan-state semantics を standalone YARAで同型保証できないため安全側へ寄せる。
  - 変更: `src/yara.rs` の `lower_pcre_offset_window_condition(...)` で `Exact && r` を `false + note` に統一。
  - テスト: `tests/yara_rule.rs` / `tests/yara_compile.rs` に `10:0/abc/r` fixture を追加・更新し、note と scan non-match を固定。
- 2026-02-16 追記72: PCRE flags/trigger-prefix の複雑条件として、`*` offset 上で `r/e` を使うケースを strict-safe false 化。
  - 背景: 既存実装は `*` offset に `r/e` が付いても ignore していたが、ClamAV runtime の scan-state 依存挙動を standalone YARA で同型に保証できないため安全側へ寄せる。
  - 変更: `src/yara.rs` の `lower_pcre_offset_condition(...)` で `offset=CLI_OFF_ANY(*) && (r||e)` を `false + note` に統一。
  - テスト: `tests/yara_rule.rs` / `tests/yara_compile.rs` に `*:0/abc/re` fixture を追加し、note と scan non-match を固定。
- 2026-02-16 追記71: PCRE flags/trigger-prefix の複雑条件として、offset prefix なしで `r/e` を使うケースを strict-safe false 化。
  - 背景: 既存実装は `r/e` を「offsetなしでは無視」としていたが、ClamAV runtime の scan-state 依存挙動を standalone YARA で同型に担保できないため安全側に寄せる。
  - 変更: `src/yara.rs` の `lower_pcre_offset_condition(...)` で `offset=None && (r||e)` の場合は `false + note` に統一。
  - テスト: `tests/yara_rule.rs` / `tests/yara_compile.rs` に `0&1;41414141;0/abc/re` fixture を追加し、note と scan non-match を固定。
- 2026-02-16 追記70: PCRE trigger-prefix の trigger式で count/distinct 演算子を含むケースを strict-safe false 化。
  - 背景: trigger prefix 側は主に boolean trigger（subsig参照の AND/OR）を固定してきたが、count/distinct まで含む複合式は runtime semantics の同型性を十分に証明できていなかった。
  - 変更: `src/yara.rs` で trigger式 IR が `MatchCount/Gt/Lt/Multi*` を含む場合は `false + note` に統一（単純 `SubExpression` / `And` / `Or` のみ representable 扱い）。
  - テスト: `tests/yara_rule.rs` / `tests/yara_compile.rs` に `200,300:(0|1)=1/abc/` fixture を追加し、note と scan non-match を固定。
- 2026-02-16 追記69: PCRE trigger-prefix の self-reference 判定を厳密化し、混在参照（例: `0|self`）も strict-safe false 化。
  - 背景: 既存実装は trigger式が self-only で `false` 解決になるケースのみ self-reference として扱っており、`0|self` のように他subsigを含む自己参照を取りこぼす余地があった。
  - 変更: `src/yara.rs` で trigger expression IR 内に self index が **1つでも含まれる場合**は `false + note` に統一（`libclamav/matcher-pcre.c:232-239` の self-referential reject に合わせる）。
  - テスト: `tests/yara_rule.rs` / `tests/yara_compile.rs` に `0|1/abc/i`（self混在）fixture を追加し、note に `self-referential` が出ることと scan non-match を固定。
- 2026-02-16 追記68: `fuzzy_img` strict-safe path を専用lower関数へ切り出し、malformed境界の fixture を追加して挙動を固定。
  - 背景: 既存実装は分岐内 inline で `false + note` を生成しており、`fuzzy_img` ルールの境界ケース（missing hash / extra separators）を将来変更時に壊しやすかった。
  - 変更: `src/yara.rs` に `lower_fuzzy_img_subsignature(...)` を追加し、`fuzzy_img#` 系の判定・note付与・strict-false を専用化。既存の `clamav_unsupported=fuzzy_img_hash_runtime_match` は維持。
  - テスト: `tests/yara_rule.rs` / `tests/yara_compile.rs` に `fuzzy_img#af2ad01ed42993c7#0#1`（separator過多）と `fuzzy_img##0`（missing hash）の strict-false fixture を追加。
- 2026-02-16 追記67: target description の `Container` / `Intermediates` strict-false 経路に machine-readable unsupported meta を追加。
  - 背景: 既存実装は `false + note` で安全化していたが、他の未同型要素と同様に unsupported分類を機械可読で収集できなかった。
  - 変更: logical lowering で `Container` 検出時に `clamav_unsupported=target_description_container_constraint`、`Intermediates` 検出時に `clamav_unsupported=target_description_intermediates_constraint` を付与。
  - テスト: `tests/yara_rule.rs` に meta付与の assertion を追加（既存 strict-false/note テストを拡張）。
- 2026-02-15 追記66: exec target 側（PE）の `Sx/SE/SL` 境界挙動を section index の valid/out-of-range で scan fixture 固定。
  - 背景: これまで offset prefix の式生成は固定されていたが、exec target での section index 境界（`nsections-1` / out-of-range）の実scan挙動が十分に固定されていなかった。
  - 変更: `tests/yara_compile.rs` に最小PE fixture（2 sections）を追加し、`S1+4` / `SE1,4` / `SL+4` は match、`S2+4` / `SE2,4` は non-match を固定。
  - source根拠: `libclamav/matcher.c` の `cli_caloff` 再計算分岐（`CLI_OFF_SX_PLUS` / `CLI_OFF_SE` / `CLI_OFF_SL_PLUS`、out-of-range section は `CLI_OFF_NONE`）。
- 2026-02-15 追記65: `EOF-...,maxshift,e` の encompass 窓でも match-end 拘束（`@ + ! <= end`）が効くことを scan fixture で固定。
  - 背景: 追記63で `@ + !` 条件へ厳密化済みだが、fixture は absolute/section 系中心で `EOF-` 窓の実scan固定が不足していた。
  - 変更: `tests/yara_rule.rs` に `EOF-5,3:0/abc/e` の condition 生成チェックを追加。`tests/yara_compile.rs` に non-match（`EOF-5,3`）/match（`EOF-5,5`）の scan fixture を追加。
  - source根拠: `libclamav/matcher.c:393-400`（`EOF-` parse）, `libclamav/matcher-pcre.c:624-629`（encompass時の `adjlength=adjshift`）。
- 2026-02-15 追記64: Target非exec時の relative executable offset strict化について `SL+` / `SE` 系 fixture を追加し、`EP/Sx/SL/SE` 全系統をテスト固定。
  - 背景: 追記62で non-exec target に対する `EP/Sx/SL/SE` を false+note 化済みだが、fixture は `EP` / `Sx` のみで `SL+` / `SE` が未固定だった。
  - 変更: `tests/yara_rule.rs` / `tests/yara_compile.rs` に `Target:0` + `SL+16` / `SE1,4` の strict-false fixture を追加し、note文言（offset種別 + target制約）まで検証。
  - source根拠: `libclamav/matcher.c:455-459`（relative executable offset の target 制約）。
- 2026-02-15 追記63: PCRE `e`（encompass）range の上限拘束を、match-start だけでなく match-end まで含めて厳密化。
  - 背景: ClamAV `matcher-pcre.c` の encompass 実装は `adjlength=adjshift` で検索バッファ長自体を絞るため、開始位置だけでなく **match終端** が `offset+maxshift` を超えないことが成立条件になる。既存lowerは `@start <= end` のみで終端拘束がなく、長いregexで過検知しうる。
  - 変更: `src/yara.rs` の range window 条件を `@{id}[j] >= start && (@{id}[j] + !{id}[j]) <= end` に変更し、`!`（match length）を使って終端境界を反映。
  - source根拠: `libclamav/matcher-pcre.c:624-629`（`encompass` 時の `adjlength=adjshift`）, `656-657`（その長さで `cli_pcre_match` 実行）。
  - テスト: `tests/yara_rule.rs` で condition に `@ + ! <= ...` が出ることを固定。`tests/yara_compile.rs` に ClamAV fixture 相当（`3,7:0/34567890/e` は non-match、`3,8:0/12345678/e` は match）を追加。
- 2026-02-15 追記62: PCRE trigger-prefix の relative executable offsets（`EP+/-`, `Sx+`, `SL+`, `SE`）に target 制約を反映し、Target非exec時を strict-safe false 化。
  - 背景: `cli_caloff` は `CLI_OFF_ANY` / `CLI_OFF_ABSOLUTE` / `CLI_OFF_EOF_MINUS` / `CLI_OFF_MACRO` 以外（= `EP/Sx/SL/SE`）について、target が `PE/ELF/MachO` でない場合に malformed（`CL_EMALFDB`）として拒否する。
  - 変更: `src/yara.rs` の `lower_pcre_offset_condition(...)` に `target_description.target_type` を渡し、target が `PE/ELF/MachO` 以外（IR上の `any` など）で `EP/Sx/SL/SE` offset が来たら **false + note** に統一。
  - source根拠: `libclamav/matcher.c:455-459`（relative executable offset の target 制約）、`348-454`（`cli_caloff` offset parse 分岐）。
  - テスト: `tests/yara_rule.rs` / `tests/yara_compile.rs` に `Target:0` + `EP+10` / `S2+4,8` fixture を追加し strict-false を固定。
- 2026-02-15 追記61: PCRE offset `*,maxshift` を source準拠で malformed 扱いに厳密化。
  - 背景: 既存実装は `*,10` を `*` 同等として受理していたが、ClamAV `cli_caloff` は `"*"` のみを CLI_OFF_ANY として受理し、`*,10` は malformed。
  - 変更: `src/yara.rs` の `parse_pcre_offset_spec(...)` で `base=="*" && maxshiftあり` を unsupported として `false + note` 化。
  - source根拠: `libclamav/matcher.c:360-363`（`"*"` 受理）, `371-380`（`,` split）, `444-447`（`*` の absolute parse失敗で invalid）。
  - テスト: `tests/yara_rule.rs` / `tests/yara_compile.rs` に `*,10:0/abc/e` fixture を追加し strict-false を固定。
- 2026-02-15 追記60: malformed PCRE subsignature の raw fallback 経路を閉じ、strict-safe false に統一。
  - 背景: 既存lowerは `parse_pcre_like(...)` 失敗時に通常raw文字列へ落ちるため、`0/abc` のような slash含有 malformed が literal match として残る余地があった。
  - 変更: `src/yara.rs` に `looks_like_pcre_subsignature(...)`（`/` 含有）を追加し、PCRE parse失敗時は **`pcre subsignature format unsupported/invalid + false`** に統一。
  - source根拠: `libclamav/readdb.c` は slash含有 subsig を PCRE path へ先行分岐して処理するため（plain content-match fallbackしない）。
  - テスト: `tests/yara_rule.rs` / `tests/yara_compile.rs` に malformed fixture（`0/abc`）を追加し、condition=false / scan non-match を固定。
- 2026-02-15 追記59: PCRE trigger-prefix strict化の残スライスとして、self-referential trigger を **false + note** に厳密化。
  - 背景: 既存lowerでは trigger式が self-reference の場合に implicit self-match 扱いへ逃がしていたが、ClamAV source では loader 時点で malformed（`CL_EMALFDB`）として拒否される。
  - 変更: `src/yara.rs` の `lower_pcre_trigger_condition(...)` で self-referential trigger を検出したら `false + note` を返すよう変更。
  - source根拠: `libclamav/matcher-pcre.c:232-239`（`logical trigger is self-referential` で error return）。
  - テスト: `tests/yara_rule.rs` / `tests/yara_compile.rs` に self-referential fixture（`0;0/abc/i`）の strict-false を追加。既存の inline flag (`sm/x/U`) fixture は non-self trigger へ移して継続検証。
- 2026-02-15 追記58: `fuzzy_img` subsig を含む logical rule に `clamav_unsupported=fuzzy_img_hash_runtime_match` を付与するよう更新。
  - 背景: `fuzzy_img` は false+note で安全化済みだが、他DB typeと同様に unsupported分類を機械可読に載せたい。
  - 変更: `lower_subsignatures(...)` で `fuzzy_img#` subsig検出フラグを集約し、`lower_logical_signature_with_ndb_context(...)` で meta へ unsupported key を追加（valid/malformed の双方で付与）。
  - テスト: `tests/yara_rule.rs` で valid/malformed fuzzy_img の `clamav_unsupported` メタ付与を検証。
- 2026-02-15 追記57: `fuzzy_img` strict-safe の parser境界を ClamAV source 準拠で明確化。
  - 背景: 既存 `parse_fuzzy_img_subsignature(...)` は hash 長を制限せず、`fuzzy_img#abcdef#0` のような短い hash も「非表現要素」として扱っていた。
  - 変更: `src/yara.rs` で `fuzzy_img` parse を `Option<Result<...>>` 化し、`fuzzy_img#` prefix の入力を専用判定。hash は **16 hex chars（8-byte）必須**、distance は unsigned integer のみ許可（省略時0）。違反時は詳細理由つきで **format unsupported/invalid + false**。
  - source根拠: `libclamav/readdb.c`（`fuzzy_img` format loadエラーメッセージ）, `libclamav_rust/src/fuzzy_hash.rs`（`ImageFuzzyHash` は length 16 必須、distance は `u32` parse、`distance!=0` は InvalidHammingDistance）。
  - テスト: `tests/yara_rule.rs` / `tests/yara_compile.rs` に `fuzzy_img#abcdef#0`（short hash）と `#x`（invalid distance token）の strict-false fixture を追加。
- 2026-02-15 追記56: `macro` linked NDB target 拡張として `target_type=4`（MAIL）を strict subset に追加。
  - 背景: linked member の strict subset を `target_type=3` まで拡張後も、MAIL向け NDB member は安全に表現可能でも false 側に倒れていた。
  - 変更: `target_type=4` を許可し、macro member clause に MAIL guard（`ndb_mail_target_condition()`）を併置。`target_type in {0,1,2,3,4,5,6,7,9,10,11,12}` 以外は引き続き strict-safe false（ignored）。
  - テスト: `tests/yara_rule.rs` / `tests/yara_compile.rs` に fixture 追加（mail fixture match、`MZ` fixture non-match、`target_type=8` は false）。
- 2026-02-15 追記55: `macro` linked NDB target 拡張として `target_type=3`（HTML）を strict subset に追加。
  - 背景: linked member の strict subset を `target_type=7` まで拡張後も、HTML向け NDB member は安全に表現可能でも false 側に倒れていた。
  - 変更: `target_type=3` を許可し、macro member clause に HTML guard（`ndb_html_target_condition()`）を併置（※その後の追記56で現行許可集合は `{0,1,2,3,4,5,6,7,9,10,11,12}` へ拡張）。
  - テスト: `tests/yara_rule.rs` / `tests/yara_compile.rs` に fixture 追加（HTML fixture match、`MZ` fixture non-match、`target_type=4` は false）。
- 2026-02-15 追記54: `macro` linked NDB target 拡張として `target_type=7`（ASCII）を strict subset に追加。
  - 背景: linked member の strict subset を `target_type=5` まで拡張後も、ASCII向け NDB member は安全に表現可能でも false 側に倒れていた。
  - 変更: `target_type=7` を許可し、macro member clause に ASCII guard（`ndb_ascii_target_condition()`）を併置。`target_type in {0,1,2,5,6,7,9,10,11,12}` 以外は引き続き strict-safe false（ignored）。
  - テスト: `tests/yara_rule.rs` / `tests/yara_compile.rs` に fixture 追加（lowercase ASCII fixture match、非printable byte fixture non-match、`target_type=4` は false）。
- 2026-02-15 追記53: `macro` linked NDB target 拡張として `target_type=5`（graphics）を strict subset に追加。
  - 背景: linked member の strict subset を `target_type=2` まで拡張後も、graphics向け NDB member は安全に表現可能でも false 側に倒れていた。
  - 変更: `target_type=5` を許可し、macro member clause に graphics guard（`ndb_graphics_target_condition()` 相当の magic 判定）を併置。`target_type in {0,1,2,5,6,9,10,11,12}` 以外は引き続き strict-safe false（ignored）。
  - テスト: `tests/yara_rule.rs` / `tests/yara_compile.rs` に fixture 追加（PNGヘッダあり match、`MZ` fixture non-match、`target_type=3` は false）。
- 2026-02-15 追記52: `macro` linked NDB target 拡張として `target_type=2`（OLE2）を strict subset に追加。
  - 背景: linked member の strict subset を `target_type=12` まで拡張後も、OLE2向け NDB member は安全に表現可能でも false 側に倒れていた。
  - 変更: `target_type=2` を許可し、macro member clause に OLE2 guard（`uint32(0) == 0xE011CFD0 and uint32(4) == 0xE11AB1A1`）を併置。`target_type in {0,1,2,6,9,10,11,12}` 以外は引き続き strict-safe false（ignored）。
  - テスト: `tests/yara_rule.rs` / `tests/yara_compile.rs` に fixture 追加（OLE2ヘッダあり match、`MZ` fixture non-match、`target_type=5` は false）。
- 2026-02-15 追記51: `macro` linked NDB target 拡張として `target_type=12`（Java class）を strict subset に追加。
  - 背景: linked member の strict subset を `target_type=11` まで拡張後も、Java class向け NDB member は安全に表現可能でも false 側に倒れていた。
  - 変更: `target_type=12` を許可し、macro member clause に Java class guard（`uint32(0) == 0xBEBAFECA`）を併置。`target_type=2+`（6/9/10/11/12除く）は引き続き strict-safe false（ignored）。
  - テスト: `tests/yara_rule.rs` / `tests/yara_compile.rs` に fixture 追加（`CAFEBABE` ヘッダあり match、`MZ` fixture non-match、`target_type=2` は false）。
- 2026-02-15 追記50: `macro` linked NDB target 拡張として `target_type=11`（SWF）を strict subset に追加。
  - 背景: linked member の strict subset を `target_type=10` まで拡張後も、SWF向け NDB member は安全に表現可能でも false 側に倒れていた。
  - 変更: `target_type=11` を許可し、macro member clause に SWF magic guard（`(uint8(0) == 0x46 or uint8(0) == 0x43 or uint8(0) == 0x5A) and uint8(1) == 0x57 and uint8(2) == 0x53`）を併置。`target_type=2+`（6/9/10/11除く）は引き続き strict-safe false（ignored）。
  - テスト: `tests/yara_rule.rs` / `tests/yara_compile.rs` に fixture 追加（`FWS` ヘッダあり match、`MZ` fixture non-match、`target_type=2` は false）。
- 2026-02-15 追記49: `macro` linked NDB target 拡張として `target_type=10`（PDF）を strict subset に追加。
  - 背景: linked member の strict subset を `target_type=9` まで拡張後も、PDF向け NDB member は安全に表現可能でも false 側に倒れていた。
  - 変更: `target_type=10` を許可し、macro member clause に PDF magic guard（`uint32(0) == 0x46445025`）を併置。`target_type=2+`（6/9/10除く）は引き続き strict-safe false（ignored）。
  - テスト: `tests/yara_rule.rs` / `tests/yara_compile.rs` に fixture 追加（`%PDF` ヘッダあり match、`MZ` fixture non-match、`target_type=2` は false）。
- 2026-02-15 追記48: `macro` linked NDB target 拡張として `target_type=9`（Mach-O/FAT）を strict subset に追加。
  - 背景: linked member の strict subset を `target_type=6` まで拡張後も、Mach-O/FAT 向け NDB member は安全に表現可能でも false 側に倒れていた。
  - 変更: `target_type=9` を許可し、macro member clause に Mach-O/FAT magic guard（`uint32(0)` の6種）を併置。`target_type=2+`（6/9除く）は引き続き strict-safe false（ignored）。
  - テスト: `tests/yara_rule.rs` / `tests/yara_compile.rs` に fixture 追加（Mach-O/FATヘッダあり match、ELF fixture non-match、`target_type=2` は false）。
- 2026-02-15 追記47: `macro` linked NDB target 拡張として `target_type=6`（ELF）を strict subset に追加。
  - 背景: linked member の strict subset を `target_type=1` まで拡張後も、ELF向け NDB member は安全に表現可能でも false 側に倒れていた。
  - 変更: `target_type=6` を許可し、macro member clause に `uint32(0) == 0x464C457F` guard を併置。`target_type=2+`（6除く）は引き続き strict-safe false（ignored）。
  - テスト: `tests/yara_rule.rs` / `tests/yara_compile.rs` に fixture 追加（ELFヘッダあり match、MZ fixture non-match、`target_type=2` は false）。
- 2026-02-15 追記46: `macro` の linked NDB target 拡張として `target_type=1`（PE/MZ）を strict subset に追加。
  - 背景: 既存は linked member を `target_type=0` のみに制限していたため、PE向け NDB member が安全に表現可能でも false 側に倒れていた。
  - 変更: `target_type=1` を許可し、macro member clause に `uint16(0) == 0x5A4D` guard を併置。`target_type=2+` は引き続き strict-safe false（ignored）。
  - テスト: `tests/yara_rule.rs` / `tests/yara_compile.rs` に fixture 追加（MZあり match、非MZ non-match、`target_type=2` は false）。
- 2026-02-15 追記45: `macro` の ndb strict subset 連携を CLI 経路へ接続。
  - 背景: 既存の `lower_logical_signature_with_ndb_context(...)` は API 経路のみで、CLI から linked NDB を渡せなかった。
  - 変更: `sig2yar logical` に `--ndb-context <NDB_SIG>`（repeatable）を追加し、指定時は linked NDB を parse して strict subset 連携を有効化。
  - テスト: `src/bin/sig2yar/main.rs` に unit test 追加（context なし strict-false / context あり link 成立 / invalid context エラー）、`src/bin/sig2yar/args.rs` に引数parse test追加。
- 2026-02-15 追記44: `byte_comparison` threshold の leading-zero token 境界（base-0/octal）を fixture で固定。
  - 背景: ClamAV source の compare value parse（`strtoll(..., 0)`）に合わせ、digit-only かつ先頭 `0` の token を octal として扱う必要がある。
  - 変更: `010` は 8 として受理、`08` のような invalid octal は malformed 扱い。
  - テスト: `tests/yara_rule.rs` / `tests/yara_compile.rs` に fixture 追加（`0(>>0#de2#=010)` は `"08"` match、`0(>>0#de2#=08)` は strict-false）。
- 2026-02-15 追記43: `byte_comparison` threshold の `0x..` 受理境界を fixture で固定。
  - 背景: compare value は source上 signed/auto-base 側の文脈を持つため、`0x` プレフィックス token の受理可否を明示し、bare hex-alpha との境界を固定したい。
  - 変更: decimal base では bare hex-alpha（例: `A0`）のみ strict false とし、`0xA` は受理して `10` 相当で lower。
  - テスト: `tests/yara_rule.rs` / `tests/yara_compile.rs` に fixture 追加（`0(>>0#de2#=0xA)` match）。
- 2026-02-15 追記42: `byte_comparison` offset の base-0 挙動固定として、octal offset fixture（`>>010`）を追加。
  - 背景: `strtol(..., 0)` 準拠では先頭0付き数値は octal になるため、`010` は decimal 10 ではなく 8。
  - 変更: 既存base-0実装に対しテストを追加し、`>>010` が `+8` として評価されることを固定化。
  - テスト: `tests/yara_rule.rs` / `tests/yara_compile.rs` に fixture 追加（`>>010` match / decimal 10 fixture non-match）。
- 2026-02-15 追記41: `byte_comparison` 残edge-caseの1スライスとして、offset 数値解釈を ClamAV source の `strtol(..., 0)` 相当に寄せた。
  - 背景: 既存実装は bare-hex（例: `>>0A`）を受理していたが、ClamAV source parser は base-0 のため bare-hex を受理しない。
  - 変更: `src/yara.rs` で offset parse を base-0 化（`0x..` / octal / decimal を受理、bare-hex は parse失敗→malformed strict-safe false）。
  - テスト: `tests/yara_rule.rs` / `tests/yara_compile.rs` に fixture 追加（`>>0xA` は受理、`>>0A` は false）。
- 2026-02-15 追記40: `byte_comparison` 残edge-caseの1スライスとして、negative comparison value を **strict-safe false + note** へ変更。
  - 背景: ClamAV source は compare value を `strtoll` で signed 受理するが、現行YARA lowerの値抽出モデル（特に raw `i`）で signed runtime semantics を同型化しきれないため。
  - 変更: `src/yara.rs` の byte_comparison lowering で負値を検出したら rule条件を `false` に倒す。
  - テスト: `tests/yara_rule.rs` / `tests/yara_compile.rs` に fixture 追加（`0(>>3#ib2#>-1)`）。
- 2026-02-15 追記39: `byte_comparison` 残edge-caseの1スライスとして、raw (`i`) の byte length を ClamAV source 準拠で **1/2/4/8 のみ許可** に厳密化し、それ以外を **strict-safe false + note** へ変更。
  - 背景: `libclamav/matcher-byte-comp.c` の binary extraction は switch で `1/2/4/8` のみ処理し、それ以外は invalid byte size として拒否する。
  - 変更: `src/yara.rs` の raw byte_comparison lowering で size を `1/2/4/8` に限定し、`3/5/6/7` などは false 化。
  - テスト: `tests/yara_rule.rs` / `tests/yara_compile.rs` に fixture 追加（`0(>>4#ib3#=12)`）。
- 2026-02-15 追記38: `byte_comparison` 残edge-caseの1スライスとして、comparison clause が **3件以上** のケースを **strict-safe false + note** へ変更。
  - 背景: ClamAV source（`libclamav/matcher-byte-comp.c`）では比較式はコンマ0/1個のみを受理し、`comp_count` は 1 または 2 に限定される。
  - 変更: `src/yara.rs` の `lower_byte_comparison_condition(...)` で `comparisons.len() > 2` を safety false 化。
  - テスト: `tests/yara_rule.rs` / `tests/yara_compile.rs` に fixture 追加（`0(>>3#de3#>100,<900,=123)`）。
- 2026-02-15 追記37: PCRE flags 残課題の1スライスとして、`A`（anchored）単体も **strict-safe false + note** へ変更。
  - 背景: ClamAVのanchor評価は matcher runtime の scan-context（開始位置/対象バッファ文脈）依存で、standalone YARA `\\A`（ファイル先頭固定）と安全に同型化できないため。
  - 変更: `src/yara.rs` で `A` を受けた場合は rule条件を `false` に倒す（`anchor+offset` / `anchor+r/e` の既存strict化は維持）。
  - テスト: `tests/yara_rule.rs` / `tests/yara_compile.rs` に fixture 追加（`0/abc/A`）。
- 2026-02-15 追記36: PCRE flags 残課題の1スライスとして、legacy `a` を anchored扱いから外し **strict-safe false + note** へ変更。
  - 背景: `a` は legacy 互換フラグで source準拠の同型化根拠を保持しづらく、`A` と同義に寄せると近似リスクが残るため。
  - 変更: `src/yara.rs` で `a` を unsupported flag として扱い、rule条件を `false` に倒す。
  - テスト: `tests/yara_rule.rs` / `tests/yara_compile.rs` に fixture 追加（`0/abc/a`）。
- 2026-02-15 追記35: PCRE flags 残課題の1スライスとして、`g` を no-op 扱いから外し **strict-safe false + note** へ変更。
  - 背景: standalone YARA と ClamAV matcher runtime の探索/再走査挙動を同型化できる根拠が薄く、近似回避を優先。
  - 変更: `src/yara.rs` で `g` を unsupported flag として扱い、rule条件を `false` に倒す。
  - テスト: `tests/yara_rule.rs` / `tests/yara_compile.rs` に fixture 追加（`0/abc/g`）。
- 2026-02-15 追記34: PCRE trigger-prefix strict化の1スライスとして、`A/a` anchor flag と `cli_caloff`/flag複合のうち非同型化ケースを **strict-safe false + note** へ変更。
  - 背景: ClamAV runtime では anchor は offset調整後の scan start 相対で評価されるが、YARA `\\A` はファイル先頭固定で同型化できない。さらに anchor と `r/e` の複合は matcher runtime state 依存が強く、standalone YARAで安全に一致させにくい。
  - 変更: `src/yara.rs` で `parse_pcre_trigger_prefix(...)` の offset有無を参照し、`anchor+offset` と `anchor+(r|e)` の場合は rule条件を `false` に倒す（近似禁止）。
  - テスト: `tests/yara_rule.rs` / `tests/yara_compile.rs` に fixture 追加（`10:0/abc/A`, `0/abc/Ar`）。
- 2026-02-15 追記33: `cfg/info` の扱い方針を確定。いずれも **シグネチャ本体ではなくDBメタデータ** として `parse対象` を追加し、YARAへの同型変換は行わず **strict-safe false + note** に統一。
  - `cfg`: `src/parser/cfg.rs` を追加。`DOMAIN:FLAGS:MINFL:MAXFL`（`FLAGS` は `0x` hex、`MINFL<=MAXFL`）を受理。`DbType::Cfg` / `ir::CfgSignature` / `render/lower_cfg_signature` を追加。
  - `info`: `src/parser/info.rs` を追加。`RecordType:Payload` を受理（`ClamAV-VDB` / `<file>:<size>:<sha256>` / `DSIG` などを包括）。`DbType::Info` / `ir::InfoSignature` / `render/lower_info_signature` を追加。
  - source根拠: docs `manual/Signatures`（`.cfg` / `.info` はDB運用メタデータ）。
  - `tests/yara_rule.rs` / `tests/yara_compile.rs` / `tests/ir_pipeline.rs` / `tests/clamav_db.rs` を拡張（parser単体 + strict-false compile/scan + 実DB parse/compileサンプル）。
- 2026-02-15 追記32: `ndu`（PUA-gated extended signature DB）の最小スライスとして `parse対象` を追加。`src/parser/ndu.rs` を新設し、`NdbSignature::parse` を再利用して `.ndu` を `name:target_type:offset:body[:min[:max]]` 形式として取り込み、`DbType::Ndu` を CLI へ接続し、`src/ir.rs` に `NduSignature` を追加。
  - source根拠: docs `manual/Signatures`（`*u` 拡張子は PUA mode でロード, `.ndb/.ndu` は extended signature record）。
  - `src/yara.rs` に `render/lower_ndu_signature` を追加。PUA mode/runtime gating を YARA単体で厳密再現しない方針として **strict-safe false + note** に統一（近似禁止）。
  - `tests/yara_rule.rs` / `tests/yara_compile.rs` / `tests/ir_pipeline.rs` / `tests/clamav_db.rs` を拡張（parser単体 + strict-false compile/scan + 実DB parse/compileサンプル）。
- 2026-02-15 追記31: `mdu/msu`（PUA-gated section-hash signature DB）の最小スライスとして `parse対象` を追加。`src/parser/mdu.rs` / `src/parser/msu.rs` を新設し、Hash signature parserを土台に `.mdu` は **MD5 section hashのみ**、`.msu` は **SHA1/SHA256 section hashのみ**を受理、file-hash形式は strict に拒否するよう実装。`DbType::Mdu` / `DbType::Msu` を CLI へ接続し、`src/ir.rs` に `MduSignature` / `MsuSignature` を追加。
  - source根拠: docs `manual/Signatures`（`*u` 拡張子は PUA mode でロード）, docs `manual/Signatures/HashSignatures`（`PESectionSize:Hash:MalwareName[:MinFL]`）。
  - `src/yara.rs` に `render/lower_mdu_signature` / `render/lower_msu_signature` を追加。PUA mode/runtime gating を YARA単体で厳密再現しない方針として **strict-safe false + note** に統一（近似禁止）。
  - `tests/yara_rule.rs` / `tests/yara_compile.rs` / `tests/ir_pipeline.rs` / `tests/clamav_db.rs` を拡張（parser単体 + strict-false compile/scan + 実DB parse/compileサンプル）。
- 2026-02-15 追記30: `hdu/hsu`（PUA-gated hash signature DB）の最小スライスとして `parse対象` を追加。`src/parser/hdu.rs` / `src/parser/hsu.rs` を新設し、Hash signature parserを土台に `.hdu` は **MD5 file hashのみ**、`.hsu` は **SHA1/SHA256 file hashのみ**を受理、section-hash形式は strict に拒否するよう実装。`DbType::Hdu` / `DbType::Hsu` を CLI へ接続し、`src/ir.rs` に `HduSignature` / `HsuSignature` を追加。
  - source根拠: docs `manual/Signatures`（`*u` 拡張子は PUA mode でロード）, docs `manual/Signatures/HashSignatures`（`HashString:FileSize:MalwareName[:MinFL]`）。
  - `src/yara.rs` に `render/lower_hdu_signature` / `render/lower_hsu_signature` を追加。PUA mode/runtime gating を YARA単体で厳密再現しない方針として **strict-safe false + note** に統一（近似禁止）。
  - `tests/yara_rule.rs` / `tests/yara_compile.rs` / `tests/ir_pipeline.rs` / `tests/clamav_db.rs` を拡張（parser単体 + strict-false compile/scan + 実DB parse/compileサンプル）。
- 2026-02-14 追記29: `ldu`（PUA-gated logical signature DB）の最小スライスとして `parse対象` を追加。`src/parser/ldu.rs` を新設し、最小バリデーション（empty拒否・`;` delimiter必須・signature name必須）を実装。`DbType::Ldu` を CLI へ接続し、`src/ir.rs` に `LduSignature` を追加。
  - source根拠: docs `manual/Signatures`（`*.ldb *.ldu; *.idb: Logical Signatures`、`*u` 拡張子は PUA mode でロード）。
  - `src/yara.rs` に `render/lower_ldu_signature` を追加し、PUA mode 依存の logical runtime semantics は YARA単体で厳密再現不可のため **strict-safe false + note** に統一（近似禁止）。
  - `tests/yara_rule.rs` / `tests/yara_compile.rs` / `tests/ir_pipeline.rs` / `tests/clamav_db.rs` を拡張（parser単体 + strict-false compile/scan + 実DB parse/compileサンプル）。
- 2026-02-13 追記28: `ign/ign2`（ignore lists）の最小スライスとして `parse対象` を追加。`src/parser/ign.rs` / `src/parser/ign2.rs` を新設し、ClamAV source 準拠の最小バリデーション（token count 1..3、`name[:md5]` と legacy 3-token 形式の受理、md5指定時は32hex必須）を実装。`DbType::Ign` / `DbType::Ign2` を CLI へ接続し、`src/ir.rs` に `IgnSignature` / `Ign2Signature` を追加。
  - source根拠: docs `manual/Signatures/AllowLists`（`ign2` は `SignatureName[:md5(entry)]`、`.ign` は互換維持）, `libclamav/readdb.c:2721-2821`（`cli_loadign`, `IGN_MAX_TOKENS=3`, optional md5, legacy mode）。
  - `src/yara.rs` に `render/lower_ign_signature` / `render/lower_ign2_signature` を追加し、ignore-list の効果（シグネチャ抑制）は ClamAV DB load/scan flow の runtime semantics 依存で YARA単体では厳密再現不可のため **strict-safe false + note** に統一（近似禁止）。
  - `tests/yara_rule.rs` / `tests/yara_compile.rs` / `tests/ir_pipeline.rs` / `tests/clamav_db.rs` を拡張（parser単体 + strict-false compile/scan + 実DB parse/compileサンプル）。
- 2026-02-13 追記27: `fp/sfp`（file allow-list / SHA file allow-list）の最小スライスとして `parse対象` を追加。`src/parser/fp.rs` / `src/parser/sfp.rs` を新設し、Hash signature parserを土台に `.fp` は **MD5 file hashのみ**、`.sfp` は **SHA1/SHA256 file hashのみ**を受理、section-hash形式は strict に拒否するよう実装。`DbType::Fp` / `DbType::Sfp` を CLI へ接続。
  - source根拠: docs `manual/Signatures/AllowLists`（`.fp` は MD5 file allow-list、`.sfp` は SHA1/SHA256 file allow-list）, docs `manual/Signatures/HashSignatures`（hash signature format）。
  - `src/ir.rs` に `FpSignature` / `SfpSignature` を追加、`src/yara.rs` に `render/lower_fp_signature` / `render/lower_sfp_signature` を追加。
  - allow-list は ClamAV の scan-flow での suppression/override semantics（検知抑制）であり、YARA単体の positive match には安全に同型化できないため、**strict-safe false + note** に統一（近似禁止）。
  - `tests/yara_rule.rs` / `tests/yara_compile.rs` / `tests/ir_pipeline.rs` / `tests/clamav_db.rs` を拡張（parser単体 + strict-false compile/scan + 実DB parse/compileサンプル）。
- 2026-02-13 追記26: `ftm`（filetype magic）の最小スライスとして `parse対象` を追加。`src/parser/ftm.rs` に ClamAV source 準拠の最小バリデーション（`FTM_TOKENS=8` / 6..8フィールド、`MagicType`/`MinFL`/`MaxFL` numeric、`MagicType=0|4` は numeric offset + hex magic bytes、`RequiredType/DetectedType` は `CL_TYPE_*` 形式）を実装し、`DbType::Ftm` を CLI へ接続。
  - source根拠: docs `manual/Signatures/FileTypeMagic`（`magictype:offset:magicbytes:name:rtype:type[:min_flevel[:max_flevel]]`）, `libclamav/readdb.c:2468-2600`（`cli_loadftm`, `FTM_TOKENS=8`, magictype dispatch 0/1/4）。
  - `src/yara.rs` に `render/lower_ftm_signature` を追加し、filetype magic 照合は ClamAV の filetype engine（`cli_add_content_match_pattern` + `cli_ftcode` + rtype文脈）依存で YARA単体では厳密再現不可のため **strict-safe false + note** に統一（近似禁止）。
  - `tests/yara_rule.rs` / `tests/yara_compile.rs` / `tests/ir_pipeline.rs` / `tests/clamav_db.rs` を拡張（parser単体 + strict-false compile/scan + 実DB parse/compileサンプル）。
- 2026-02-13 追記23: `cbc`（bytecode）の最小スライスとして `parse対象` を追加。`src/parser/cbc.rs` に bytecode payload の最小バリデーション（empty拒否・ASCII前提）を実装し、`DbType::Cbc` を CLI へ接続。
  - source根拠: docs `manual/Signatures/BytecodeSignatures.html`（`.cbc` は ASCII bytecode encoding）, `libclamav/readdb.c:2332-2387`（`cli_loadcbc` が file payload を `cli_bytecode_load` へ渡して bytecode をロード）, `libclamav/readdb.c:2422-2457`（bytecode kind / hooks 実行系の runtime 依存）。
  - `src/yara.rs` に `render/lower_cbc_signature` を追加し、bytecode VM 実行は YARA単体で厳密再現不可のため **strict-safe false + note** に統一（近似禁止）。
  - `tests/yara_rule.rs` / `tests/yara_compile.rs` / `tests/ir_pipeline.rs` / `tests/clamav_db.rs` を拡張（parser単体 + YARA compile/scan + 実DB parse/compileサンプル）。
- 2026-02-13 追記25: PCRE trigger-prefix 残課題（`VI` / macro offset `$n$`）の最小スライスとして、`src/yara.rs` の `parse_pcre_offset_spec(...)` を ClamAV `cli_caloff` 形に寄せた。
  - `VI` 判定を `base == "VI"` から `base.starts_with("VI")` に変更（`matcher.c` の `strncmp(offcpy, "VI", 2)` 準拠）。`VIjunk` のような payload 付きでも **CLI_OFF_VERSION扱いで false+note** に統一。
  - macro offset は `base.contains('$')` を macro-intent として扱い、`$<digits>$` 形でない場合は `InvalidMacroGroup` へ分類して **false+note**（`invalid format`）へ厳密化。`$<digits>$...` trailing bytes は `sscanf("$%u$")` 準拠で group decode のみ採用。
  - `tests/yara_rule.rs` / `tests/yara_compile.rs` に `VIjunk` と malformed `$foo$` の rule/compile fixture を追加。
  - 追加fixture名: `lowers_pcre_versioninfo_prefixed_payload_to_false_for_safety` / `lowers_pcre_invalid_macro_group_offset_prefix_to_false_for_safety` / `yara_rule_with_pcre_versioninfo_prefixed_payload_false_compiles_with_yara_x` / `yara_rule_with_pcre_invalid_macro_group_offset_prefix_false_compiles_with_yara_x`。
- 2026-02-13 追記24: macro 残課題（macro group解決 / ndb連携）の最小スライスとして、`src/yara.rs` に `lower_logical_signature_with_ndb_context(...)` を追加し、macro subsig の strict subset 連携を実装。
  - 連携条件（strict-safe）: `ndb.offset=$<group>` / `target_type in {0,1,2,3,4,5,6,7,9,10,11,12}`（1は MZ guard、2は OLE2 guard、3は HTML guard、4は MAIL guard、5は graphics guard、6は ELF guard、7は ASCII guard、9は Mach-O/FAT guard、10は PDF guard、11は SWF guard、12は Java class guard 併置） / group<32 / bodyが既存NDB strict lowerで表現可能 / macro直前subsigが direct string anchor。
  - 生成条件: `subsig[idx-1]` の start offset 基準で `{min-max}` window を `for any` 条件へ lowerし、linked ndb member body を rule string として展開（例: `$m1_0`, `$m1_1`）。
  - 非表現ケース（link無し・non-direct anchor・target!=0・non-representable body）は **false + note** を維持（近似禁止）。
  - `tests/yara_rule.rs` / `tests/yara_compile.rs` に macro↔ndb link の rule/scan fixture（match/non-match + strict-false fallback）を追加。
- 2026-02-13 追記22: `wdb` の最小スライスとして `parse対象` を追加。`src/parser/wdb.rs` に ClamAV source 準拠のバリデーション（`X/Y/M` プレフィクス、`:` 区切り、`regex_list.c:functionality_level_check` と同じ末尾 `:min-max` 形式の機能レベル抽出）を実装し、`DbType::Wdb` を CLI へ接続。
  - source根拠: docs `manual/Signatures/PhishSigs.html`（`X:RealURL:DisplayedURL[:FuncLevelSpec]`, `Y:RealURL[:FuncLevelSpec]`, `M:RealHostname:DisplayedHostname[:FuncLevelSpec]`）, `libclamav/readdb.c:1593-1610`（`cli_loadwdb` が `load_regex_matcher(..., is_allow_list_lookup=1)` を使用）, `libclamav/regex_list.c:503-519,568-576`（`X/Y/M` dispatch）, `libclamav/regex_list.c:355-395`（末尾 `:min-max` での functionality-level 取り扱い）。
  - `src/yara.rs` に `render/lower_wdb_signature` を追加し、wdb allow-list 判定は ClamAV runtime の phishing URL 抽出（RealURL/DisplayedURL concat）+ regex matcher 依存で YARA単体では厳密再現不可のため **strict-safe false + note** で明示。
  - `tests/yara_rule.rs` / `tests/yara_compile.rs` / `tests/ir_pipeline.rs` / `tests/clamav_db.rs` を拡張（parser単体 + YARA compile/scan + 実DB parse/compileサンプル）。
- 2026-02-13 追記21: `byte_comparison` non-raw base の残edge-caseとして、`h` base の `num_bytes` 上限を ClamAV source 準拠（`CLI_BCOMP_MAX_HEX_BLEN=18`）で strict-safe 化。`src/yara.rs` の `lower_textual_byte_comparison_condition(...)` で `#he19#...` のような over-limit を **false + note** に統一（近似禁止）。
  - source根拠: `libclamav/matcher-byte-comp.h`（`#define CLI_BCOMP_MAX_HEX_BLEN 18`）, `libclamav/matcher-byte-comp.c`（`CLI_BCOMP_HEX` で over-limit を malformed として拒否）。
  - `tests/yara_rule.rs`: `#he19#=1` が `condition=false` + note（`non-raw hex width 19 exceeds ClamAV limit 18`）になることを追加。
  - `tests/yara_compile.rs`: 同ケースの scan fixture が非match（0 hit）になることを追加。
- 2026-02-13 追記20: `pdb` の最小スライスとして `parse対象` を追加。`src/parser/pdb.rs` に ClamAV source 準拠のバリデーション（`R/H` プレフィクス、`:` 区切り、`regex_list.c:functionality_level_check` と同じ末尾 `:min-max` 形式の機能レベル抽出）を実装し、`DbType::Pdb` を CLI へ接続。
  - source根拠: docs `manual/Signatures/PhishSigs.html`（`R:DisplayedURL[:FuncLevelSpec]`, `H:DisplayedHostname[:FuncLevelSpec]`）, `libclamav/readdb.c:1613-1627`（`cli_loadpdb` が `load_regex_matcher` を使用）, `libclamav/regex_list.c:503-577`（`R/H` の dispatch）, `libclamav/regex_list.c:355-395`（末尾 `:min-max` での functionality-level 取り扱い）。
  - `src/yara.rs` に `render/lower_pdb_signature` を追加し、pdb の照合は ClamAV runtime の phishing engine（RealURL/DisplayedURL 抽出 + protected-domain matcher）依存で YARA単体では厳密再現不可のため **strict-safe false + note** で明示。
  - `tests/yara_rule.rs` / `tests/yara_compile.rs` / `tests/ir_pipeline.rs` / `tests/clamav_db.rs` を拡張（parser単体 + YARA compile/scan + 実DB parse/compileサンプル）。
- 2026-02-13 追記19: `crb` の最小スライスとして `parse対象` を追加。`src/parser/crb.rs` に Authenticode cert rule のバリデーション（11..13トークン、`Trusted/CodeSign/TimeSign/CertSign` の `0|1`、`Subject` 40hex必須、`Serial` 40hexまたは空、`Pubkey` 非空hex、`NotBefore` numericまたは空、`MinFL/MaxFL` numeric）を実装し、`DbType::Crb` を CLI へ接続。
  - source根拠: docs `manual/Signatures/AuthenticodeRules.html`（`Name;Trusted;Subject;Serial;Pubkey;Exponent;CodeSign;TimeSign;CertSign;NotBefore;Comment[;minFL[;maxFL]]`）, `libclamav/readdb.c:3318-3322`（CRB format + `CRT_TOKENS=13`）, `libclamav/readdb.c:3358`（token count 11..13）, `libclamav/readdb.c:3389-3478`（trust/usage flags・`serial/not_before` optional）, `libclamav/readdb.c:3293-3311`（Subject/Serial を SHA1長で検証）。
  - `src/yara.rs` に `render/lower_crb_signature` を追加し、Authenticode の cert chain trust/revocation は ClamAV runtime の PE cert verification/trust store 依存で YARA単体では厳密再現不可のため **strict-safe false + note** で明示。
  - `tests/yara_rule.rs` / `tests/yara_compile.rs` / `tests/ir_pipeline.rs` / `tests/clamav_db.rs` を拡張（parser単体 + YARA compile/scan + 実DB parse/compileサンプル）。
- 2026-02-13 追記18: `cdb` の最小スライスとして `parse対象` を追加。`src/parser/cdb.rs` に ClamAV source 準拠のバリデーション（10..12トークン、`ContainerSize/FileSizeInContainer/FileSizeReal/FilePos` の `*|n|n-m`、`IsEncrypted` の `*|0|1`、`MinFL/MaxFL` numeric）を実装し、`DbType::Cdb` を CLI へ接続。
  - source根拠: docs `ContainerMetadata`（`VirusName:ContainerType:...:Res2[:MinFL[:MaxFL]]`）, `libclamav/readdb.c:3112-3137`（`CDB_TOKENS=12`, token count, optional MinFL/MaxFL）, `libclamav/readdb.c:3234-3244`（range fields + encryption flag検証）。
  - `src/yara.rs` に `render/lower_cdb_signature` を追加し、container metadata matching は ClamAV runtime の container traversal / metadata（size, encrypted flag, file position, CRC）依存で YARA単体では厳密再現不可のため **strict-safe false + note** で明示。
  - `tests/yara_rule.rs` / `tests/yara_compile.rs` / `tests/ir_pipeline.rs` / `tests/clamav_db.rs` を拡張（parser単体 + YARA compile/scan + 実DB parse/compileサンプル）。
- 2026-02-13 追記17: `fuzzy_img` 継続トラックの最小スライスとして、**malformed `fuzzy_img` を raw literal にフォールバックさせない** strict-safe 化を実施。
  - 背景: 既存実装は `parse_fuzzy_img_subsignature(...)` 成功時のみ `false + note` 化していたため、`fuzzy_img#zz...#0` のような malformed ケースが通常文字列としてlowerされる余地があった。
  - 変更: `src/yara.rs` に `looks_like_fuzzy_img_subsignature(...)` を追加し、`fuzzy_img#` prefix なのにparse失敗する場合は **`false + lowering note`** に統一（近似禁止）。
  - `tests/yara_rule.rs`: malformed fuzzy_img が `condition=false` / `strings` 空 / note（`fuzzy_img format unsupported/invalid`）になることを追加。
  - `tests/yara_compile.rs`: 同ケースの scan fixture（`xxfuzzy_img#zz...#0yy`）が非match（0 hit）になることを追加。
- 2026-02-13 追記16: `idb` の最小スライスとして `parse対象` を追加。`src/parser/idb.rs` に ClamAV source 準拠のバリデーション（4トークン、`ICON_HASH` 124桁hex、先頭サイズprefixが 16/24/32）を実装し、`DbType::Idb` を CLI へ接続。
  - source根拠: `libclamav/readdb.c:1365-1376`（token count / hash length）, `libclamav/readdb.c:1388-1397`（hex文字・size=16/24/32）, docs `LogicalSignatures`（`.idb` format: `ICONNAME:GROUP1:GROUP2:ICON_HASH`）。
  - `src/yara.rs` に `render/lower_idb_signature` を追加し、icon fuzzy matching は ClamAV runtime（icon matcher + ldb IconGroup linkage）依存で YARA単体では厳密再現不可のため **strict-safe false + note** で明示。
  - `tests/yara_rule.rs` / `tests/yara_compile.rs` / `tests/ir_pipeline.rs` / `tests/clamav_db.rs` を拡張（parser単体 + YARA compile/scan + 実DB parse/compileサンプル）。
- 2026-02-13 追記15: macro 継続トラックの最小スライスとして、malformed macro（`${6-7}0` のような trailing `$` 欠落）を raw literal にフォールバックさせず **strict-safe false + note** に統一。
  - 背景: 既存実装は `looks_like_macro_subsignature` が `${...}$` の完全形のみ検知していたため、`${...` で始まる malformed macro が raw string としてlowerされ得た。
  - 変更: `src/yara.rs` で macro判定を `${` prefix 起点に変更し、parse失敗時は既存の invalid-format 分岐へ確実に入れる。
  - `tests/yara_rule.rs`: `0|1;41414141;${6-7}0` が `($s0 or false)` になり、note（`macro subsignature format unsupported/invalid`）を持つことを追加。
  - `tests/yara_compile.rs`: 同ケースで scan fixture（`xx${6-7}0yy`）が非match（0 hit）になることを追加。
  - 検証: `cargo test --locked --test yara_rule --test yara_compile` と `cargo test --locked --all-targets` 通過。
- 2026-02-13 追記13: `byte_comparison` non-raw base の残edge-caseとして、`a` (auto) base を strict-safe で **false + note** に統一。`src/yara.rs` の `lower_textual_byte_comparison_condition(...)` で non-raw auto-base を拒否する分岐を追加（runtime auto-detection近似を禁止）。
  - `tests/yara_rule.rs`: `#ae2#=10` で rule condition が `false` かつ note（`auto base unsupported for strict lowering`）を確認。
  - `tests/yara_compile.rs`: 同ケースで scan fixture（`xx10yy`）が非match（0 hit）になることを確認。
- 2026-02-13 追記14: hex modifier の 1スライス前進として、ClamAV `libclamav/readdb.c:cli_sigopts_handler` の `w/a/f` 挙動を再確認し、`src/yara.rs` の hex lowering を更新。
  - `w`: hex bytes を `XX 00` へ wide化して文字列化（`i` 併用時は ASCII alpha の nocase alternation を保持）。
  - `a+w`: 単一YARA hex string内で `(ascii_variant | wide_variant)` を生成し、ClamAVの `ASCII` 追加パターン読込に対応。
  - `f`: ClamAV fullword境界（`matcher-ac.c` の `isalnum` / wide時 `isalnum(byte)&&next==0`）を現状厳密表現しない方針として **false + note** へ統一。
  - `tests/yara_rule.rs` / `tests/yara_compile.rs` に wide/wa/iwa の rule文字列・compile・scan fixture と `::f` strict-false を追加。
  - 検証: `cargo test --locked --test yara_rule --test yara_compile` と `cargo test --locked --all-targets` 通過。
- 2026-02-13 追記12: PCRE trigger-prefix strict化の最小スライスとして、trigger式が lowering で `false` に解決されたケース（未解決subsig参照など）を「constraint ignored」から **false + note** へ変更。`src/yara.rs` の `lower_pcre_trigger_condition(...)` で strict-safe を徹底。
  - `tests/yara_rule.rs`: `9/abc/`（trigger参照先なし）で rule condition が `false` かつ note を確認。
  - `tests/yara_compile.rs`: 同ケースが scan で非match（`abc` を与えても 0 hit）を確認。
  - 検証: `cargo test --locked --test yara_rule --test yara_compile` と `cargo test --locked --all-targets` 通過。
- 2026-02-13 追記11: malformed な `byte_comparison` を raw 文字列として扱わないよう strict 化。`src/yara.rs` に `looks_like_byte_comparison(...)` を追加し、構文が byte_comparison 形なのに parse 失敗した場合は **safety false + note** に統一。
  - `tests/yara_rule.rs`: invalid threshold token（`#he2#=1G`）で strict-false note を確認。
  - `tests/yara_compile.rs`: 同ケースが scan で非match（literalとして誤マッチしない）を確認。
  - 検証: `cargo test --locked --test yara_rule --test yara_compile` と `cargo test --locked --all-targets` 通過。
- 2026-02-13 追記10: `byte_comparison` の `h` base 閾値解釈を修正。`src/yara.rs` で比較値トークンの parse を base-aware 化し、`h` 指定時は **数字のみトークンも hex 値として解釈**（`=10` を `0x10` として扱う）。
  - `tests/yara_rule.rs` に `#he2#=10` が "10"（0x31,0x30）へ lower されることを追加。
  - `tests/yara_compile.rs` に scan fixture を追加（`"10"` は match、`"0A"` は non-match）。
  - 検証: `cargo test --locked --test yara_rule --test yara_compile` と `cargo test --locked --all-targets` 通過。
- 2026-02-13 追記9: `MultiGt` / `MultiLt` の複合式（grouped expression）で使っていた distinct-count 近似を廃止し、`src/yara.rs` の lower を **safety false + note** に統一。単一subsigの occurrence count (`#sN`) は従来どおり反映。
  - `tests/yara_rule.rs` の grouped `MultiGt` / `MultiLt` ケースを strict-false 検証へ更新。
  - 検証: `cargo test --locked --test yara_rule --test yara_compile` と `cargo test --locked --all-targets` 通過。
- 2026-02-12 追記8: NDB-6（`[]` positional structure strictness）として、`src/yara.rs` に `[]` 位置構造バリデーションを追加。ClamAV source（`libclamav/matcher-ac.c:2767-2836`, `libclamav/matcher-ac.c:1286-1304,1365-1381`）準拠で、**single-byte flank + core**（dual-`[]` は single-byte/core/single-byte）を満たす場合のみ lower を許可し、それ以外（single-byte flank 不成立 / `[]` 3個以上 / 非canonical dual-`[]`）は safety false + note へ統一。
  - `tests/yara_rule.rs` / `tests/yara_compile.rs` に representable dual-flank の match/non-match と strict-false note/scan を追加（source参照コメント付き）。
  - `cargo test --locked --test yara_rule --test yara_compile` と `cargo test --locked --all-targets` 通過。
- 2026-02-12 追記7: NDB-5（target_type/offset fixture expansion）として、`tests/yara_rule.rs` / `tests/yara_compile.rs` に以下を追加。
  - target_type: reserved(8) / internal+(13,14) / non-numeric invalid (`foo`) を **safety false + note** で固定化（ClamAV参照: `libclamav/matcher.h`, `libclamav/readdb.c`）。
  - offset: representable boundary `1,1` の match/non-match scan、non-representable `1,` / `EP10` / `EOF+10` / target_type=0 での `EP+10` を **strict false + note** で固定化（ClamAV参照: `libclamav/matcher.c:cli_caloff`）。
  - 実装側も strictness整合のため `src/yara.rs` を最小修正（`EP+/EP-` と `EOF-` 形式の厳格化、relative offset の target_type 制約チェック）。
- 2026-02-12 追記6: NDB-4（complex range-jump strictness）として、`src/yara.rs` の ndb jump lower を更新。`{-15}` のような **signed jump** は近似変換（`[0-15]`）を廃止して safety false + note 化。`[]` は ClamAV source（`libclamav/matcher-ac.c:2751-2786`, `libclamav/matcher-ac.h:32`）に合わせて `[n]` / `[n-m]`（昇順・`<=32`）のみ許可し、open/signed bounds・降順・`AC_CH_MAXDIST`超過は safety false + note 化。`tests/yara_rule.rs` / `tests/yara_compile.rs` に representable match/non-match と strict-false note 検証を追加。`cargo test --locked --test yara_rule --test yara_compile` と `cargo test --locked --all-targets` 通過。
  - （解消）ClamAV `[]` の **位置制約**（single-byte flank / core pattern との構造制約）は 追記8（NDB-6）で strict 化を実装済み。
- 2026-02-12 追記5: NDB-3（target_type=4 MAIL edge-case strictness）として、secondary header 判定を **line-start 必須**（`offset==0` または直前が `\n`）へ厳密化し、既存の `secondary-header-before-separator` 条件と組み合わせて header/body ordering を strict 側に寄せた。曖昧ケースは拡張せず条件不成立に倒す方針を維持。ClamAV source 参照は `libclamav/mbox.c:1173-1183`（空行で header/body を分離）, `libclamav/mbox.c:1263-1268,1330-1391`（header行の parse）, `libclamav/mbox.c:1310-1316`（header未検出は email扱いしない）。`tests/yara_rule.rs` / `tests/yara_compile.rs` に sourceコメント付きで match/non-match（line-start header / `X-Subject:` / separator後header）を追加。`cargo test --locked --test yara_rule --test yara_compile` と `cargo test --locked --all-targets` 通過。
- 2026-02-12 追記4: NDB-2（target_type=3 HTML edge-case strictness）として、root/close tag 判定に **tag terminator (`>`/ASCII空白) 境界** を必須化し、`root-before-close` 条件でも同境界を要求するよう更新。曖昧ケースは拡張せず strict 側（条件不成立）に寄せた。ClamAV source 参照は `libclamav/scanners.c:2563-2589`（normalized HTML scan）, `libclamav/htmlnorm.c:962-1000,1229-1249`（タグトークン境界/終端タグ処理）。`tests/yara_rule.rs` / `tests/yara_compile.rs` に sourceコメント付きで match/non-match（`</html>` vs `</htmlx>`）を追加。`cargo test --locked --test yara_rule --test yara_compile` と `cargo test --locked --all-targets` 通過。
- 2026-02-12 追記3: NDB-1 として target_type=7 の strictness を更新。ClamAV `libclamav/textnorm.c`（uppercase→lowercase 正規化）に合わせ、条件を `printable + lowercase alpha 必須 + uppercase 不許可` へ寄せた。`tests/yara_rule.rs` / `tests/yara_compile.rs` に source参照コメント付き検証を追加。`cargo test --locked --test yara_rule --test yara_compile` と `cargo test --locked --all-targets` 通過。
- 2026-02-12 進捗: Cisco-Talos/clamav 公式fixture（`unit_tests/check_matchers.c` の pcre_testdata、`unit_tests/clamscan/regex_test.py`、`unit_tests/clamscan/fuzzy_img_hash_test.py`）を根拠に、`tests/yara_rule.rs` / `tests/yara_compile.rs` を拡張。PCRE exact offset を `==` で固定するケース、`/atre/re` + `2,6`（`r`無視+encompass window）ケース、`fuzzy_img` 非表現要素（2nd subsig併用・distance!=0）を **safety false + note** で明示検証。`cargo test --locked --test yara_rule --test yara_compile` と `cargo test --locked --all-targets` 通過。
- 2026-02-12 追記: macro-group と complex PCRE trigger-prefix の残ブロッカーを source準拠で厳密化。macro は `${min-max}group$` を group解釈し、runtime `macro_lastmatch` 依存のため safety false 化（invalid format / group>=32 も false）。PCRE trigger-prefix は `check_matchers.c` Test8/Test10・`regex_test.py` offset fixture を追加検証し、unsupported offset prefix（`EP+...`）および `$n$` macro offset を safety false + note 化。`cargo test --locked --test yara_rule --test yara_compile` と `cargo test --locked --all-targets` 再通過。
- 2026-02-12 追記2: `cli_caloff` 残フォーム（`*`, `EP-`, `Sx+`, `SL+`, `SE`, `EOF-`）をPCRE trigger-prefix lowerに追加し、`tests/yara_rule.rs` / `tests/yara_compile.rs` を拡張。`SE` は ClamAV同様に section size を maxshiftへ加味し、`e`なしは safety false 維持。`VI` / `$n$` macro offset / 非数値payloadは safety false + note を維持。`cargo test --locked --test yara_rule --test yara_compile` と `cargo test --locked --all-targets` 通過。

`clamav-db/unpacked` の現物には以下拡張子が存在（2026-02-11時点）:

- `hdb hsb mdb msb ldb ndb idb cdb crb cbc pdb wdb ftm fp sfp ign ign2 hdu hsu ldu mdu msu ndu cfg info`
